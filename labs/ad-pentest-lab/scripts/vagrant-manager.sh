#!/usr/bin/env bash

# =============================================================================
# Vagrant Manager (libvirt-only) â€” Pentest / Windows Lab
# Version: 2.1 (Safe Bash, Fixed get_machine_ip and array subscripts)
# =============================================================================

readonly MIN_VAGRANT_VERSION="2.2.0"
readonly TEMP_RDP_FILE="/tmp/vagrant-rdp-info.txt"
readonly NAME_COL_WIDTH=28
DEBUG="${DEBUG:-0}"

export VAGRANT_DEFAULT_PROVIDER="libvirt"
PROVIDER_FLAG="--provider=libvirt"

RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'
BLUE='\033[0;34m'; PURPLE='\033[0;35m'; CYAN='\033[0;36m'
WHITE='\033[1;37m'; MAGENTA='\033[0;35m'; NC='\033[0m'

print_error(){ printf "%b\n" "${RED}[âœ—] $1${NC}"; }
print_warning(){ printf "%b\n" "${YELLOW}[!] $1${NC}"; }
print_success(){ printf "%b\n" "${GREEN}[âœ“] $1${NC}"; }
print_info(){ printf "%b\n" "${CYAN}[i] $1${NC}"; }
print_debug(){ [[ "$DEBUG" != "0" ]] && printf "%b\n" "${PURPLE}[debug] $1${NC}"; }

hr(){ local w=${COLUMNS:-80}; printf '%*s\n' "$w" '' | tr ' ' '-'; }

# Declare arrays
declare -gA machine_states ip_cache
declare -ga machine_names
declare -gA group_pentest group_windows group_other
TOTAL_MACHINE_OPTIONS=0

# =============================================================================
# DEPENDENCIES
# =============================================================================
check_dependencies(){
    local missing=()
    command -v vagrant >/dev/null || missing+=("vagrant")
    command -v virsh >/dev/null || print_warning "virsh not found - IP detection limited"
    command -v nc >/dev/null || print_warning "nc not found - port checks disabled"
    command -v ping >/dev/null || print_warning "ping not found - connectivity checks disabled"
    command -v ssh >/dev/null || missing+=("ssh")

    if (( ${#missing[@]} )); then
        print_error "Missing required: ${missing[*]}"; exit 1
    fi
    print_success "All required dependencies found"
}

# =============================================================================
# STATES
# =============================================================================
state_icon(){
    case "$1" in
        running)     echo -e "${GREEN}â–¶${NC}" ;;
        poweroff)    echo -e "${RED}â¹${NC}" ;;
        suspended)   echo -e "${CYAN}â¸${NC}" ;;
        not_created) echo -e "${YELLOW}â—‹${NC}" ;;
        saved)       echo -e "${PURPLE}ðŸ’¾${NC}" ;;
        *)           echo -e "${WHITE}â—${NC}" ;;
    esac
}

color_state(){
    case "$1" in
        running)     echo -e "${GREEN}running${NC}" ;;
        poweroff)    echo -e "${RED}poweroff${NC}" ;;
        suspended)   echo -e "${CYAN}suspended${NC}" ;;
        not_created) echo -e "${YELLOW}not_created${NC}" ;;
        saved)       echo -e "${PURPLE}saved${NC}" ;;
        *)           echo -e "${WHITE}unknown${NC}" ;;
    esac
}

truncate_name(){
    local n="$1"
    (( ${#n} > NAME_COL_WIDTH )) && printf '%sâ€¦' "${n:0:NAME_COL_WIDTH-1}" || printf '%s' "$n"
}

# =============================================================================
# MACHINE STATE
# =============================================================================
get_machine_states(){
    machine_states=()
    machine_names=()
    declare -A seen_ci=()
    print_debug "Getting vagrant status..."
    
    local raw
    raw=$(vagrant status --machine-readable 2>/dev/null)
    [[ -z "$raw" ]] && { print_error "Failed to get vagrant status"; exit 1; }
    
    while IFS=',' read -r _ target type data _; do
        [[ "$type" != "state" ]] && continue
        [[ -z "$target" || "$target" == "undefined" ]] && continue
        target="$(echo -e "$target" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
        [[ -z "$target" ]] && continue
        
        local key="${target,,}"
        [[ -n "${seen_ci[$key]}" ]] && continue

        local state="not_created"
        case "${data,,}" in
            running)       state="running" ;;
            poweroff|shutoff) state="poweroff" ;;
            suspended|saved)  state="suspended" ;;
            "not created"|not_created) state="not_created" ;;
        esac
        
        machine_states["$target"]="$state"
        machine_names+=("$target")
        seen_ci["$key"]="$target"
        print_debug "Found: $target â†’ $state"
    done <<< "$raw"
    
    mapfile -t machine_names < <(printf '%s\n' "${machine_names[@]}" | sort -u)
    (( ${#machine_names[@]} == 0 )) && { print_error "No machines found"; exit 1; }
    print_debug "Total machines: ${#machine_names[@]}"
}

# =============================================================================
# GROUPING
# =============================================================================
categorize_machines(){
    group_pentest=(); group_windows=(); group_other=()
    for m in "${machine_names[@]}"; do
        [[ -z "$m" ]] && continue
        local state="${machine_states[$m]:-not_created}"
        local ml="${m,,}"
        if [[ "$ml" =~ (kali|msf|juice|pentest|target|cloud|metasploitable|llm|pnpt|oscp|pjpt) ]]; then
            group_pentest["$m"]="$state"
        elif [[ "$ml" =~ (win|dc|sql|ca|db|server) ]]; then
            group_windows["$m"]="$state"
        else
            group_other["$m"]="$state"
        fi
    done
}

# =============================================================================
# IP CACHE (FIXED)
# =============================================================================
get_machine_ip(){
    local m="$1"
    [[ -z "$m" ]] && { echo "unknown"; return 1; }
    [[ -n "${ip_cache[$m]}" ]] && { echo "${ip_cache[$m]}"; return 0; }
    
    local ip=""
    
    # Try vagrant ssh-config first
    if command -v vagrant >/dev/null; then
        ip=$(vagrant ssh-config "$m" 2>/dev/null | awk '/HostName/ {print $2}' | head -1)
    fi
    
    # Fallback to virsh
    if [[ -z "$ip" ]] && command -v virsh >/dev/null 2>&1; then
        if virsh dominfo "$m" >/dev/null 2>&1; then
            ip=$(virsh domifaddr "$m" 2>/dev/null | grep -v vnet | awk '{print $4}' | cut -d'/' -f1 | head -1)
        fi
    fi
    
    ip="${ip:-unknown}"
    ip_cache["$m"]="$ip"
    echo "$ip"
}

# =============================================================================
# HEALTH CHECK
# =============================================================================
check_vm_health(){
    local m="$1"
    [[ -z "$m" ]] && { print_error "No VM specified"; return 1; }
    
    clear
    printf "${CYAN}â•â•â•â•â•â•â•â• Health Check: %s â•â•â•â•â•â•â•â•${NC}\n\n" "$m"
    
    local ip=$(get_machine_ip "$m")
    print_info "IP Address: $ip"
    
    if command -v ping >/dev/null && [[ "$ip" != "unknown" ]]; then
        if ping -c2 -W2 "$ip" >/dev/null 2>&1; then
            print_success "âœ“ ICMP reachable"
        else
            print_warning "âœ— ICMP not reachable"
        fi
    fi
    echo ""
    read -p "Press Enter to continue..."
}

# =============================================================================
# VM OPERATIONS
# =============================================================================
start_machine(){ vagrant up "$1" $PROVIDER_FLAG; refresh_status; }
halt_machine(){ vagrant halt "$1"; refresh_status; }
suspend_machine(){ vagrant suspend "$1"; refresh_status; }
destroy_machine(){ vagrant destroy -f "$1"; refresh_status; }
connect_ssh(){ vagrant ssh "$1"; }

refresh_status(){ get_machine_states; categorize_machines; }

# =============================================================================
# BATCH OPERATIONS
# =============================================================================
batch_start_group(){
    local name="$1"; local -n g="$2"
    for vm in "${!g[@]}"; do
        [[ -n "$vm" ]] && start_machine "$vm" &
    done
    wait; refresh_status
}

batch_halt_group(){
    local name="$1"; local -n g="$2"
    for vm in "${!g[@]}"; do
        [[ -n "$vm" ]] && halt_machine "$vm" &
    done
    wait; refresh_status
}

# =============================================================================
# DISPLAY
# =============================================================================
display_menu(){
    clear
    local ts=$(date '+%Y-%m-%d %H:%M:%S')
    printf "${CYAN}Vagrant Lab Manager v2.10 â”€â”€ %s${NC}\n" "$ts"
    printf "${BLUE}"; hr; printf "${NC}\n\n"
    
    local idx=1; declare -gA machine_options=()
    
    show_group(){
        local title="$1"; local -n g="$2"; local color="$3"
        (( ${#g[@]} == 0 )) && return
        printf "${color}â”€â”€â”€ %s (%d) â”€â”€â”€${NC}\n" "$title" "${#g[@]}"
        printf " Nr   Name                             State\n"
        printf "${BLUE}"; hr; printf "${NC}\n"
        
        for m in $(printf '%s\n' "${!g[@]}" | sort); do
            local s="${g[$m]:-not_created}"
            printf " %02d   %-28s %b %s\n" "$idx" "$(truncate_name "$m")" "$(state_icon "$s")" "$(color_state "$s")"
            machine_options[$idx]="$m"
            ((idx++))
        done
        echo
    }
    
    show_group "Pentest VMs" group_pentest "$PURPLE"
    show_group "Windows VMs" group_windows "$GREEN"
    show_group "Other VMs" group_other "$WHITE"
    
    TOTAL_MACHINE_OPTIONS=$((idx-1))
    
    printf "${WHITE}â”€â”€â”€ Actions â”€â”€â”€${NC}\n"
    printf "${CYAN}[A] Start All  [B] Halt All  [S] Save All  [D] Destroy All\n"
    printf "${CYAN}[P] Start Pentest  [W] Start Windows  [X] Halt Pentest  [Y] Halt Windows\n"
    printf "${CYAN}[R] Refresh  [L] List All  [H] Health Check  [Q] Quit${NC}\n\n"
}

# =============================================================================
# MAIN MENU
# =============================================================================
main_menu(){
    while true; do
        display_menu
        read -p "Select: " sel
        case "${sel^^}" in
            Q) exit 0 ;;
            R) refresh_status ;;
            L) for m in "${machine_names[@]}"; do echo "$m"; done; read -p "Press Enter..." ;;
            H) for m in "${machine_names[@]}"; do check_vm_health "$m"; done ;;
            A) for m in "${machine_names[@]}"; do [[ -n "$m" ]] && start_machine "$m" & done; wait; refresh_status ;;
            B) for m in "${machine_names[@]}"; do [[ -n "$m" ]] && halt_machine "$m" & done; wait; refresh_status ;;
            S) for m in "${machine_names[@]}"; do [[ -n "$m" ]] && suspend_machine "$m" & done; wait; refresh_status ;;
            D) for m in "${machine_names[@]}"; do [[ -n "$m" ]] && destroy_machine "$m" & done; wait; refresh_status ;;
            P) batch_start_group "Pentest" group_pentest ;;
            W) batch_start_group "Windows" group_windows ;;
            X) batch_halt_group "Pentest" group_pentest ;;
            Y) batch_halt_group "Windows" group_windows ;;
            *)
                if [[ "$sel" =~ ^[0-9]+$ ]] && (( sel >=1 && sel <= TOTAL_MACHINE_OPTIONS )); then
                    local vm="${machine_options[$sel]}"
                    read -p "Action [s=start h=halt c=ssh u=suspend d=destroy]: " act
                    case "${act,,}" in
                        s) start_machine "$vm" ;;
                        h) halt_machine "$vm" ;;
                        c) connect_ssh "$vm" ;;
                        u) suspend_machine "$vm" ;;
                        d) destroy_machine "$vm" ;;
                        *) print_error "Invalid action"; sleep 1 ;;
                    esac
                else
                    print_error "Invalid selection"
                    sleep 1
                fi
                ;;
        esac
    done
}

# =============================================================================
# INIT
# =============================================================================
init(){
    print_info "Initializing Vagrant Manager v2.10..."
    command -v vagrant >/dev/null || { print_error "Vagrant not installed"; exit 1; }
    check_dependencies
    get_machine_states
    categorize_machines
    print_success "Ready! Found ${#machine_names[@]} unique VMs"
}

# Start
init && main_menu
