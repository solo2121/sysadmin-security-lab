# ğŸ§ª Active Directory Pentest Lab (libvirt/KVM)

> **Enterpriseâ€‘style Active Directory attackâ€‘chain laboratory** designed for PJPT / CRTPâ€‘style training using **Vagrant + libvirt/KVM**.

âš ï¸ **Intentionally vulnerable. Lab use only. Do NOT expose to the internet.**

---

## ğŸ¯ Lab Objectives

This lab enables handsâ€‘on practice of:

- Full **Active Directory attack chains** (initial access â†’ DA)
- **Kerberos abuses** (ASâ€‘REP roast, Kerberoast, delegation)
- **AD CS attacks** (ESC1 / ESC6 / ESC8 / ESC9)
- **SMB relay & NTLM coercion**
- **Lateral movement & privilege escalation**
- **Hybrid attacks** (cloud creds, containers, web apps)

---

## ğŸ§± Lab Topology

### Internal Corporate LAN

- **Subnet:** `172.28.128.0/24`
- **Isolation:** Full L2 isolation (no routing)
- **Purpose:** All attack traffic stays internal

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  NAT (libvirt default) â”‚
                     â”‚  Internet / Updates    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚     Corporate Internal LAN       â”‚
                â”‚       172.28.128.0/24            â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Kali    â”‚  â”‚  DC01    â”‚  â”‚  CA01    â”‚  â”‚  WIN10   â”‚
   â”‚ .10      â”‚  â”‚ .21      â”‚  â”‚ .24      â”‚  â”‚ .30      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ–¥ï¸ Machines & Roles

| Hostname        | IP            | Role                    |
| --------------- | ------------- | ----------------------- |
| kali-libvirt    | 172.28.128.10 | Attacker (dual NIC)     |
| DC01            | 172.28.128.21 | Domain Controller       |
| DB01            | 172.28.128.23 | SQL / Kerberoast target |
| CA01            | 172.28.128.24 | AD Certificate Services |
| WIN10           | 172.28.128.30 | Domain workstation      |
| vuln-ubuntu     | 172.28.128.11 | Cloud / DevOps target   |
| metasploitable2 | 172.28.128.12 | Legacy Linux            |
| metasploitable3 | 172.28.128.13 | Web server              |
| msf-win2k8      | 172.28.128.14 | Legacy Windows          |
| juice-shop      | 172.28.128.15 | OWASP web app           |

---

## ğŸŒ Networking (CRITICAL â€“ libvirt)

This lab **does NOT use VirtualBox hostâ€‘only networking**.

### Design Rules

- âœ… **Two NICs per VM**
  - NIC 1: NAT (updates only)
  - NIC 2: Isolated corporate LAN

- âœ… **Static IPs** required
- âœ… Named libvirt network with `forward_mode: none`
- âŒ Do **NOT** rely on DHCP

> Misconfigured networking will break AD, Kerberos, DNS, and SMB relay.

---

## ğŸš€ Deployment

### Requirements

```bash
sudo dnf install libvirt virt-install qemu-kvm
vagrant plugin install vagrant-libvirt vagrant-reload
```

### Start the lab

```bash
cd labs/ad-pentest-lab
vagrant up
```

---

## ğŸ§  Postâ€‘Boot Checklist

### Windows Hosts

- DNS set to **DC01 (172.28.128.21)**
- LAN NIC = domain traffic only
- NAT NIC = no DNS

### Kali

```bash
ip a
ip route
```

Ensure:

- Attacks go via `172.28.128.0/24`
- Internet traffic uses NAT

---

## ğŸ§ª Suggested Attack Path

1. Network enumeration (LLMNR / SMB / LDAP)
2. ASâ€‘REP roasting
3. Kerberoasting SQL service
4. SMB relay to AD CS
5. Certipy ESC1 â†’ DA
6. Lateral movement
7. Cloud credential abuse

---

## âš ï¸ Safety Notice

- Never bridge this lab to a real network
- Never reuse credentials
- Snapshot frequently
- Treat all tooling as **live weapons**

---

## ğŸ“š References

- AD Security Fundamentals
- SpecterOps AD Attack Paths
- Microsoft AD CS documentation
- Certipy & Impacket toolchains

---

**For training, education, and authorized testing only.**
