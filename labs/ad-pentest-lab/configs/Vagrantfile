# -*- mode: ruby -*-
# vi: set ft=ruby :

# ============================================================
# VAGRANT PENTEST / WINDOWS LAB – ENTERPRISE SECURITY TESTING ENVIRONMENT
# COMPLETE ACTIVE DIRECTORY ATTACK CHAIN SIMULATION WITH MODERN CLOUD VECTORS
# ============================================================

# ==============================================================================
# Author: Miguel A. Carlo
# Project: PJPT Offensive Active Directory Pentest Lab
# Version: 1.0 – Enterprise Edition
# Build Date: 2026-01-06
#
# Description:
#   This Vagrantfile builds a comprehensive, intentionally vulnerable enterprise
#   environment designed for penetration testing certification preparation and
#   hands-on security training.
#
#   LAB ARCHITECTURE OVERVIEW:
#   ==========================
#   This lab simulates a modern corporate network with hybrid cloud integration,
#   designed to practice the full attack chain from initial access to domain
#   compromise and cloud privilege escalation.
#
#   NETWORK SEGMENTS:
#   -----------------
#   1. MANAGEMENT NETWORK (NAT)
#      - Internet access for updates and tool installation
#      - All VMs have NAT interface for package management
#      - Isolated from attack simulations
#
#   2. CORPORATE INTERNAL NETWORK (172.28.128.0/24)
#      - Isolated attack simulation environment
#      - No external connectivity – pure internal network
#      - All attack traffic contained within this subnet
#      - Realistic enterprise IP addressing scheme
#
#   TARGET DISTRIBUTION:
#   --------------------
#   A. WINDOWS DOMAIN ENVIRONMENT:
#      • DC01 (172.28.128.21) - Domain Controller
#        - Active Directory Forest: lab.local
#        - Intentionally weak configurations for training
#        - AD Certificate Services with vulnerable templates
#        - GPP passwords, SMB relay vulnerabilities
#
#      • DB01 (172.28.128.23) - Database Server
#        - SQL Server Express with Kerberoastable service account
#        - Misconfigured shares, weak local credentials
#        - Real database for credential harvesting practice
#
#      • WIN10 (172.28.128.30) - Windows 10 Workstation
#        - Domain-joined endpoint for lateral movement
#        - Weak user credentials, misconfigured services
#        - Typical corporate desktop setup
#
#      • CA01 (172.28.128.24) - Certificate Authority
#        - AD Certificate Services for Certipy attacks
#        - ESC1, ESC6, ESC8 vulnerabilities pre-configured
#        - Web enrollment enabled for relay attacks
#
#   B. LINUX / CLOUD ENVIRONMENT:
#      • kali-libvirt (172.28.128.10) - Attack Platform
#        - Kali Linux with dual NICs (NAT + Internal)
#        - Pre-installed tools for AD and cloud attacks
#        - Pivoting point for all attack simulations
#
#      • pentestplus-target (172.28.128.16) - PenTest+ Target
#        - Modern enterprise Linux with cloud tooling
#        - AWS credentials, Docker misconfigurations
#        - Vulnerable web applications and APIs
#
#      • pjpt-target (172.28.128.17) - PJPT Target
#        - Basic Linux target for PJPT exam practice
#        - Weak credentials, misconfigured services
#        - File transfer and privilege escalation
#
#      • oscp-target (172.28.128.18) - OSCP Target
#        - Linux target for OSCP-style challenges
#        - SUID binaries, NFS misconfigurations
#        - Local privilege escalation practice
#
#      • cloud-pentest (172.28.128.19) - Cloud Pentest Target
#        - Modern cloud and DevOps vulnerabilities
#        - AWS, Azure, GCP credentials exposure
#        - CI/CD secret leaks, Docker misconfigurations
#
#      • pnpt-internal (172.28.128.50) - PNPT Internal Host
#        - Internal network only (no NAT)
#        - SMB, Apache, MySQL misconfigurations
#        - Credential reuse scenarios
#
#      • metasploitable2 (172.28.128.12) - Legacy System
#        - Classic vulnerable Linux distribution
#        - Buffer overflows, service exploitation
#        - Privilege escalation practice
#
#      • metasploitable3-ubuntu (172.28.128.13) - Web Application Server
#        - Modern web application vulnerabilities
#        - SQL injection, XSS, file upload flaws
#
#      • metasploitable3-win2k8 (172.28.128.14) - Legacy Windows Server
#        - Windows Server 2008 vulnerabilities
#        - MS08-067, weak SMB configurations
#
#      • juice-shop (172.28.128.15) - Web Application Target
#        - OWASP Juice Shop for web application testing
#        - Modern JavaScript vulnerabilities
#        - API security testing
#
#   ATTACK PATHS CONFIGURED:
#   -----------------------
#   1. ACTIVE DIRECTORY ATTACKS:
#      • AS-REP Roasting (svc_asrep account)
#      • Kerberoasting (svc_kerberoast with SQL SPNs)
#      • Constrained Delegation (svc_delegate)
#      • ACL Abuse (Helpdesk → Domain Admins)
#      • AdminSDHolder modification
#      • GPP Password Extraction
#      • SMB Relay Attacks
#
#   2. AD CERTIFICATE SERVICES:
#      • ESC1 - Template Misconfiguration
#      • ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2
#      • ESC8 - Web Enrollment Relay
#      • ESC9 - Weak Certificate Binding
#
#   3. CLOUD & CONTAINER ATTACKS:
#      • Exposed Docker Socket (Container Escape)
#      • Hardcoded Cloud Credentials (AWS/Azure/GCP)
#      • Terraform State File Secrets
#      • Ansible Vault Weak Passwords
#      • Kubernetes Misconfigurations
#
#   4. WEB APPLICATION ATTACKS:
#      • OWASP Top 10 via Juice Shop
#      • Modern Node.js and API vulnerabilities
#      • JWT Secret Leakage
#      • Debug Endpoint Exposure
#
#   5. PRIVILEGE ESCALATION:
#      • Local Windows Privilege Escalation
#      • Linux Kernel Exploits
#      • Service Misconfigurations
#      • Credential Reuse
#
#   TRAINING USE CASES:
#   -------------------
#   • PJPT (Practical Junior Penetration Tester) Exam Preparation
#   • CRTP (Certified Red Team Professional) Style Labs
#   • Active Directory Attack Chain Practice
#   • Cloud Security Testing
#   • Container Security Assessment
#   • Web Application Penetration Testing
#   • Lateral Movement Techniques
#   • Privilege Escalation Methods
#   • Certificate-Based Attacks
#
#   NETWORK SECURITY NOTES:
#   -----------------------
#   • All external risk mitigated through isolated networking
#   • No production connectivity – lab use only
#   • All vulnerable configurations intentionally preserved
#   • Realistic enterprise architecture simulation
#   • Safe for controlled training environments
#
# WARNING:
#   This environment is intentionally insecure.
#   DO NOT reuse any configuration, credentials, or techniques from this
#   file in production environments.
#   DO NOT expose this lab to the internet.
#   DO NOT use real credentials or sensitive data.
#
#   For educational and authorized penetration testing purposes only.
#   Use exclusively in controlled, isolated environments.
#
# ==============================================================================

# ------------------------------------------------------------
# DOMAIN CONSTANTS
# ------------------------------------------------------------
DOMAIN_NAME = "lab.local"
DOMAIN_NETBIOS = "LAB"
DC_IP = "172.28.128.21"
LAB_SUBNET = "172.28.128.0/24"

# ------------------------------------------------------------
# PASSWORD CONSTANTS
# ------------------------------------------------------------
VAGRANT_DEFAULT_PASSWORD = "vagrant"
VAGRANT_UPDATED_PASSWORD = "Vagrant123!"
DOMAIN_JOIN_USER = "svc_join"
DOMAIN_JOIN_PASS = "JoinP@ss!"

# ------------------------------------------------------------
# DYNAMIC DOMAIN DN CONSTRUCTION
# ------------------------------------------------------------
def build_domain_dn(domain_name)
  parts = domain_name.split('.')
  parts.map { |part| "DC=#{part}" }.join(',')
end

# ------------------------------------------------------------
# ENVIRONMENT CONFIGURATION
# ------------------------------------------------------------
ENV['LIBVIRT_DEFAULT_URI'] = 'qemu:///system'
ENV['VAGRANT_LIBVIRT_SKIP_NETWORK_VALIDATION'] = 'true'
ENV['VAGRANT_LIBVIRT_VALIDATE_XML'] = 'false'
ENV['VAGRANT_WINRM_TIMEOUT'] = '3600'

Vagrant.require_version ">= 2.2.0"

# ------------------------------------------------------------
# MACHINE INDEX (STATIC IPS)
# ------------------------------------------------------------
LAB_NET = "vagrant0"

# ------------------------------------------------------------
# DEFAULT CONFIGURATIONS
# ------------------------------------------------------------
DEFAULT_CONFIG = {
  memory: 1024,
  cpus: 1,
  disk_bus: "virtio",
  nic_model_type: "virtio",
  video_type: "vga",
  video_vram: 16384
}.freeze

# REDUCED: Windows VMs with lower resources for pentesting lab
WINDOWS_CONFIG = {
  memory: 2048,      # REDUCED: 2GB RAM for Windows VMs
  cpus: 2,
  disk_size: 40,     # REDUCED: 40GB disk for Windows VMs
  nic_model_type: "e1000e",
  guest: :windows,
  communicator: "winrm",
  boot_timeout: 7200,
  video_type: "vga",
  video_vram: 16384  # REDUCED: Less VRAM for headless
}.freeze

# ------------------------------------------------------------
# SIMPLE NETWORK FUNCTION (FROM OLD WORKING FILE) - FIXED
# ------------------------------------------------------------
def configure_network(vm, ip)
  vm.vm.network :private_network,
    ip: ip,
    libvirt__network_name: "vagrant0",
    libvirt__forward_mode: "none",  # Isolated network, no NAT
    libvirt__model_type: "virtio"   # FIXED: Changed from libvirt__driver_name
end

# ------------------------------------------------------------
# LIBVIRT PROVIDER CONFIG
# ------------------------------------------------------------
def configure_libvirt(vm, overrides = {})
  settings = DEFAULT_CONFIG.merge(overrides)

  vm.vm.provider :libvirt do |libvirt|
    libvirt.memory = settings[:memory]
    libvirt.cpus = settings[:cpus]
    libvirt.disk_bus = settings[:disk_bus]
    libvirt.nic_model_type = settings[:nic_model_type]
    libvirt.video_type = settings[:video_type]
    libvirt.video_vram = settings[:video_vram]
    libvirt.default_prefix = ""
    libvirt.nested = true
    
    # Force VNC graphics instead of SPICE
    libvirt.graphics_type = "vnc"
    libvirt.graphics_ip = "127.0.0.1"
    
    # Disable SPICE and 3D acceleration
    libvirt.video_accel3d = false
    
    # Fix for vagrant-libvirt 0.12.2
    libvirt.qemu_use_session = false
    libvirt.uri = 'qemu:///system'
    
    libvirt.mgmt_attach = false
    
    # Windows-specific fixes
    if settings[:guest] == :windows
      libvirt.cpu_mode = "host-passthrough"
      libvirt.cpu_model = "host"

      begin
        libvirt.channel type: "unix",
                        target_name: "org.qemu.guest_agent.0",
                        target_type: "virtio"
      rescue NoMethodError
        # Channel not supported - silently continue
      end
    end

    # Create disk if size specified
    if settings[:disk_size]
      libvirt.storage :file,
        size: "#{settings[:disk_size]}G",
        type: "qcow2",
        bus: "virtio"
    end
  end
end

# ------------------------------------------------------------
# WINDOWS COMMUNICATION
# ------------------------------------------------------------
def configure_windows_comm(vm, user, pass)
  vm.vm.communicator = "winrm"
  vm.vm.guest = :windows
  vm.vm.boot_timeout = 7200

  vm.winrm.username = user
  vm.winrm.password = pass
  vm.winrm.transport = :plaintext
  vm.winrm.port = 5985
  vm.winrm.retry_limit = 240
  vm.winrm.retry_delay = 30
  vm.winrm.timeout = 3600
end

# ------------------------------------------------------------
# WAIT FOR DC FUNCTION - OPTIMIZED VERSION
# ------------------------------------------------------------
def wait_for_dc(vm, ip = DC_IP, max_attempts = 60)
  vm.vm.provision "shell",
    run: "once",
    inline: <<-SHELL
      $ErrorActionPreference = 'Continue'
      $attempt = 0
      $maxAttempts = #{max_attempts}
      $dcIP = '#{ip}'

      Write-Host "Waiting for Domain Controller at $dcIP to be fully ready..."

      while ($attempt -lt $maxAttempts) {
        $attempt++
        Write-Host "Attempt $attempt of $maxAttempts..."

        # Multiple checks for DC readiness
        $ready = $false
        
        # Check 1: Network connectivity
        if (Test-Connection $dcIP -Count 1 -Quiet) {
          # Check 2: SMB share for DC-FINAL.txt flag
          if (Test-Path "\\\\$dcIP\\C$\\DC-FINAL.txt") {
            Write-Host "[OK] DC01 is fully configured and ready."
            $ready = $true
            break
          } else {
            Write-Host "DC01 not fully configured yet... waiting 30s"
          }
        } else {
          Write-Host "DC01 not reachable via ICMP... waiting 30s"
        }

        Start-Sleep -Seconds 30
      }

      if (-not $ready) {
        Write-Error "Domain Controller not ready after $maxAttempts attempts"
        exit 1
      }
    SHELL
end

# ============================================================
# VAGRANT MACHINES
# ============================================================
Vagrant.configure("2") do |config|

  # ---------- KALI ----------
  config.vm.define "kali-libvirt" do |vm|
    vm.vm.box = "kalilinux/rolling"
    vm.vm.hostname = "kali"
    
    # FIXED: Kali now has both NAT (for internet) and lab network
    # 1) NAT interface for Internet access
    vm.vm.network :private_network,
      type: "dhcp",
      libvirt__network_name: "default",
      libvirt__forward_mode: "nat",
      libvirt__model_type: "virtio"
    
    # 2) Lab network (isolated)
    configure_network(vm, "172.28.128.10")
    
    # Kali uses custom libvirt config for pentesting tools
    # KEEP 4GB RAM (your current setting - don't change)
    vm.vm.provider :libvirt do |libvirt|
      libvirt.memory = 4096
      libvirt.cpus = 2
      libvirt.disk_bus = "virtio"
      libvirt.nic_model_type = "virtio"
      libvirt.video_type = "vga"
      libvirt.video_vram = 16384
      libvirt.default_prefix = ""
      libvirt.nested = true
      
      libvirt.graphics_type = "vnc"
      libvirt.graphics_ip = "127.0.0.1"
      
      libvirt.qemu_use_session = false
      libvirt.uri = 'qemu:///system'
      libvirt.mgmt_attach = false
      
      # DO NOT set disk_size - let it use box default (80GB)
    end
    
    # Network configuration script
    vm.vm.provision "shell",
      run: "once",
      inline: <<-SHELL
#!/bin/bash
set -e

# FQDN for internal lab
LAB_HOSTNAME="kali"
LAB_DOMAIN="kali.lab.local"

echo "Setting hostname..."
sudo hostnamectl set-hostname $LAB_HOSTNAME
echo "127.0.0.1 $LAB_HOSTNAME $LAB_HOSTNAME.$LAB_DOMAIN" | sudo tee -a /etc/hosts

echo "Configuring network..."
sleep 10

# Configure eth0 (NAT) for internet access
echo "Configuring eth0 for Internet access..."
ip addr show eth0

# Configure eth1 (lab network) with static IP
echo "Configuring eth1 for lab network..."
ip addr add 172.28.128.10/24 dev eth1 2>/dev/null || true
ip link set eth1 up

# Set DNS to DC for lab network
echo "nameserver 172.28.128.21" | sudo tee /etc/resolv.conf
echo "search lab.local" | sudo tee -a /etc/resolv.conf

# Add DC to hosts file
echo "172.28.128.21 dc01.lab.local dc01" | sudo tee -a /etc/hosts
echo "172.28.128.23 db01.lab.local db01" | sudo tee -a /etc/hosts
echo "172.28.128.30 win10.lab.local win10" | sudo tee -a /etc/hosts
echo "172.28.128.50 pnpt-internal.lab.local pnpt-internal" | sudo tee -a /etc/hosts

# Add default route via lab network for lab traffic
ip route add 172.28.128.0/24 dev eth1 2>/dev/null || true

echo "Kali network configuration complete!"
echo "eth0 (NAT): Internet access"
echo "eth1 (lab): 172.28.128.10/24"
echo "DNS: 172.28.128.21 (DC01)"
SHELL
  end

  # ---------- PenTest+ Target ----------
  config.vm.define "pentestplus-target" do |vm|
    vm.vm.box = "generic/ubuntu2204"
    vm.vm.hostname = "pentestplus-target"

    # NAT for updates
    vm.vm.network :private_network,
      type: "dhcp",
      libvirt__network_name: "default",
      libvirt__forward_mode: "nat"

    # Internal lab network
    configure_network(vm, "172.28.128.16")

    configure_libvirt(
      vm,
      memory: 2048,
      cpus: 2,
      disk_size: 25,
      nic_model_type: "virtio"
    )

    vm.vm.synced_folder ".", "/vagrant", disabled: true

    vm.vm.provision "shell", inline: <<-SHELL
#!/bin/bash
set -e

echo "[*] Provisioning PenTest+ 003 vulnerable target"

# Network configuration
echo "nameserver 172.28.128.21" > /etc/resolv.conf
echo "search lab.local" >> /etc/resolv.conf
echo "172.28.128.21 dc01.lab.local dc01" >> /etc/hosts
echo "172.28.128.23 db01.lab.local db01" >> /etc/hosts
echo "172.28.128.30 win10.lab.local win10" >> /etc/hosts
echo "172.28.128.50 pnpt-internal.lab.local pnpt-internal" >> /etc/hosts
echo "172.28.128.16 pentestplus-target.lab.local pentestplus-target" >> /etc/hosts

apt update
apt install -y \
  openssh-server apache2 mysql-server \
  docker.io \
  curl wget git net-tools jq \
  python3 python3-pip nodejs npm

# -------------------------
# Weak credentials
# -------------------------
useradd -m devops || true
useradd -m auditor || true
echo "devops:devops" | chpasswd
echo "auditor:auditor" | chpasswd
echo "root:toor" | chpasswd

usermod -aG sudo devops
usermod -aG docker devops

# -------------------------
# SSH misconfiguration
# -------------------------
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# -------------------------
# Docker misconfiguration
# -------------------------
systemctl enable docker
systemctl start docker
chmod 666 /var/run/docker.sock

docker run -d --name redis-open \
  -p 6379:6379 redis:5 --protected-mode no

# -------------------------
# Cloud credential exposure
# -------------------------
mkdir -p /home/devops/.aws
cat > /home/devops/.aws/credentials << 'EOF'
[default]
aws_access_key_id = AKIAIOSFODNN7EXAMPLE
aws_secret_access_key = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
region = us-east-1
EOF
chown -R devops:devops /home/devops/.aws

# -------------------------
# Infrastructure-as-Code exposure
# -------------------------
mkdir -p /opt/iac
cat > /opt/iac/main.tf << 'EOF'
provider "aws" {
  region = "us-east-1"
  access_key = "AKIAIOSFODNN7EXAMPLE"
  secret_key = "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
}
EOF

# -------------------------
# Sensitive database
# -------------------------
mysql -e "CREATE DATABASE pentest;"
mysql -e "CREATE TABLE pentest.users (id INT, user VARCHAR(50), ssn VARCHAR(11));"
mysql -e "INSERT INTO pentest.users VALUES (1,'ceo','123-45-6789');"

# -------------------------
# Vulnerable Web / API
# -------------------------
mkdir -p /opt/vuln-api
cat > /opt/vuln-api/server.js << 'EOF'
const express = require('express');
const app = express();

app.get('/api/debug', (req, res) => {
  res.json({
    jwt_secret: "supersecret",
    db_pass: "P@ssw0rd123"
  });
});

app.get('/api/user/:id', (req, res) => {
  res.send("SELECT * FROM users WHERE id = " + req.params.id);
});

app.listen(3000);
EOF

cd /opt/vuln-api
npm init -y >/dev/null
npm install express@4.16.0 >/dev/null
nohup node server.js >/dev/null 2>&1 &

# -------------------------
# Open firewall (lab only)
# -------------------------
iptables -F
iptables -P INPUT ACCEPT

systemctl restart ssh apache2 mysql

echo "[+] PenTest+ 003 target ready"
echo "    IP: 172.28.128.16"
SHELL
  end

  # ---------- PJPT Target ----------
  config.vm.define "pjpt-target" do |vm|
    vm.vm.box = "generic/ubuntu2004"
    vm.vm.hostname = "pjpt-target"

    vm.vm.network :private_network,
      type: "dhcp",
      libvirt__network_name: "default",
      libvirt__forward_mode: "nat"

    configure_network(vm, "172.28.128.17")
    configure_libvirt(vm, memory: 1024, cpus: 1)

    vm.vm.synced_folder ".", "/vagrant", disabled: true

    vm.vm.provision "shell", inline: <<-SHELL
#!/bin/bash
set -e

# Network configuration
echo "nameserver 172.28.128.21" > /etc/resolv.conf
echo "search lab.local" >> /etc/resolv.conf
echo "172.28.128.21 dc01.lab.local dc01" >> /etc/hosts
echo "172.28.128.23 db01.lab.local db01" >> /etc/hosts
echo "172.28.128.30 win10.lab.local win10" >> /etc/hosts
echo "172.28.128.50 pnpt-internal.lab.local pnpt-internal" >> /etc/hosts
echo "172.28.128.17 pjpt-target.lab.local pjpt-target" >> /etc/hosts

apt update
apt install -y openssh-server apache2 vsftpd cron net-tools

useradd -m student || true
echo "student:student" | chpasswd
echo "root:toor" | chpasswd

echo "student ALL=(ALL) NOPASSWD: /usr/bin/find" >> /etc/sudoers

cat > /etc/cron.d/backup << 'EOF'
* * * * * root /bin/tar czf /tmp/backup.tgz /home/student
EOF

systemctl restart ssh apache2 vsftpd
iptables -F
    SHELL
  end

  # ---------- OSCP Target ----------
  config.vm.define "oscp-target" do |vm|
    vm.vm.box = "generic/ubuntu2004"
    vm.vm.hostname = "oscp-target"

    vm.vm.network :private_network,
      type: "dhcp",
      libvirt__network_name: "default",
      libvirt__forward_mode: "nat"

    configure_network(vm, "172.28.128.18")
    configure_libvirt(vm, memory: 2048, cpus: 2)

    vm.vm.synced_folder ".", "/vagrant", disabled: true

    vm.vm.provision "shell", inline: <<-SHELL
#!/bin/bash
set -e

# Network configuration
echo "nameserver 172.28.128.21" > /etc/resolv.conf
echo "search lab.local" >> /etc/resolv.conf
echo "172.28.128.21 dc01.lab.local dc01" >> /etc/hosts
echo "172.28.128.23 db01.lab.local db01" >> /etc/hosts
echo "172.28.128.30 win10.lab.local win10" >> /etc/hosts
echo "172.28.128.50 pnpt-internal.lab.local pnpt-internal" >> /etc/hosts
echo "172.28.128.18 oscp-target.lab.local oscp-target" >> /etc/hosts

apt update
apt install -y openssh-server apache2 mysql-server sudo \
               nfs-kernel-server samba net-tools

useradd -m oscp || true
echo "oscp:oscp" | chpasswd

echo "oscp ALL=(root) NOPASSWD: /usr/bin/vim" >> /etc/sudoers

chmod +s /usr/bin/find
chmod +s /usr/bin/nmap

mkdir /srv/share
chmod 777 /srv/share
echo "/srv/share *(rw,no_root_squash,no_subtree_check)" >> /etc/exports

systemctl restart ssh apache2 nfs-kernel-server smbd
iptables -F
    SHELL
  end

  # ---------- Cloud Pentest Target ----------
  config.vm.define "cloud-pentest" do |vm|
    vm.vm.box = "generic/ubuntu2204"
    vm.vm.hostname = "cloud-pentest"

    # NAT only (simulates cloud workload)
    vm.vm.network :private_network,
      type: "dhcp",
      libvirt__network_name: "default",
      libvirt__forward_mode: "nat",
      libvirt__model_type: "virtio"

    vm.vm.provider :libvirt do |lv|
      lv.memory = 2048
      lv.cpus = 2
    end

    vm.vm.synced_folder ".", "/vagrant", disabled: true

    vm.vm.provision "shell", inline: <<-SHELL
#!/bin/bash
set -e

echo "[*] Cloud Pentest VM Setup"

# Network configuration
echo "nameserver 8.8.8.8" > /etc/resolv.conf
echo "search lab.local" >> /etc/resolv.conf
echo "172.28.128.21 dc01.lab.local dc01" >> /etc/hosts
echo "172.28.128.23 db01.lab.local db01" >> /etc/hosts
echo "172.28.128.30 win10.lab.local win10" >> /etc/hosts
echo "172.28.128.50 pnpt-internal.lab.local pnpt-internal" >> /etc/hosts
echo "172.28.128.19 cloud-pentest.lab.local cloud-pentest" >> /etc/hosts

apt update
DEBIAN_FRONTEND=noninteractive apt install -y \
  curl wget git unzip \
  python3 python3-pip \
  jq net-tools \
  docker.io \
  nodejs npm

# ----------------------------
# CLOUD CLI TOOLS
# ----------------------------

# AWS CLI v2
curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o aws.zip
unzip -q aws.zip
./aws/install
rm -rf aws aws.zip

# Azure CLI
curl -sL https://aka.ms/InstallAzureCLIDeb | bash

# GCP SDK
echo "deb https://packages.cloud.google.com/apt cloud-sdk main" \
  > /etc/apt/sources.list.d/google-cloud-sdk.list
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
apt update
DEBIAN_FRONTEND=noninteractive apt install -y google-cloud-sdk

# ----------------------------
# CLOUD MISCONFIGURATIONS
# ----------------------------

# AWS creds (overprivileged)
mkdir -p /root/.aws
cat > /root/.aws/credentials << EOF
[default]
aws_access_key_id = AKIAEXAMPLECLOUDPENTEST
aws_secret_access_key = CLOUDSECRETKEY1234567890
region = us-east-1
EOF

# Azure creds
mkdir -p /root/.azure
cat > /root/.azure/credentials.json << EOF
{
  "clientId": "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
  "clientSecret": "SuperInsecureAzureSecret!",
  "subscriptionId": "ffffffff-1111-2222-3333-444444444444",
  "tenantId": "55555555-6666-7777-8888-999999999999"
}
EOF

# GCP service account
mkdir -p /root/.config/gcloud
cat > /root/.config/gcloud/application_default_credentials.json << EOF
{
  "type": "service_account",
  "project_id": "cloud-pentest-project",
  "private_key_id": "deadbeefdeadbeef",
  "private_key": "-----BEGIN PRIVATE KEY-----\\nMIIEv...FAKEKEY...\\n-----END PRIVATE KEY-----\\n",
  "client_email": "cloud-admin@cloud-pentest-project.iam.gserviceaccount.com"
}
EOF

# ----------------------------
# CI/CD LEAKS
# ----------------------------

mkdir -p /opt/cicd
cat > /opt/cicd/.env << EOF
AWS_SECRET_ACCESS_KEY=CICDSECRETKEY
AZURE_CLIENT_SECRET=AzureCICDSecret
GITHUB_TOKEN=ghp_exampletoken123456
EOF

# ----------------------------
# METADATA SIMULATION
# ----------------------------

mkdir -p /opt/metadata
cat > /opt/metadata/README.md << EOF
Simulated cloud metadata endpoint.

If this were real:
- Credentials could be harvested
- Tokens abused
- IAM enumerated
EOF

# ----------------------------
# DOCKER MISCONFIG
# ----------------------------

chmod 666 /var/run/docker.sock

docker run -d --name cloud-nginx -p 8082:80 nginx:1.14 || true

iptables -F || true

echo "=================================="
echo " CLOUD PENTEST VM READY "
echo "=================================="
echo "Focus Areas:"
echo "- Cloud credentials abuse"
echo "- IAM risk analysis"
echo "- CI/CD secret leaks"
echo "- Docker privilege escalation"
echo "- Reporting cloud impact"
SHELL
  end

  # ---------- PNPT Internal Host ----------
  config.vm.define "pnpt-internal" do |vm|
    vm.vm.box = "generic/ubuntu2204"
    vm.vm.hostname = "pnpt-internal"

    # INTERNAL NETWORK ONLY (no NAT!)
    vm.vm.network :private_network,
      ip: "172.28.128.50",
      libvirt__network_name: "vagrant0",
      libvirt__forward_mode: "none",
      libvirt__model_type: "virtio"

    vm.vm.provider :libvirt do |lv|
      lv.memory = 2048
      lv.cpus = 2
    end

    vm.vm.synced_folder ".", "/vagrant", disabled: true

    vm.vm.provision "shell", inline: <<-SHELL
#!/bin/bash
set -e

echo "[*] PNPT Internal Host Setup"

# Network configuration
echo "nameserver 172.28.128.21" > /etc/resolv.conf
echo "search lab.local" >> /etc/resolv.conf
echo "172.28.128.21 dc01.lab.local dc01" >> /etc/hosts
echo "172.28.128.23 db01.lab.local db01" >> /etc/hosts
echo "172.28.128.30 win10.lab.local win10" >> /etc/hosts
echo "172.28.128.50 pnpt-internal.lab.local pnpt-internal" >> /etc/hosts

# Users (credential reuse!)
useradd -m -s /bin/bash admin || true
useradd -m -s /bin/bash developer || true
useradd -m -s /bin/bash backup || true

echo "admin:admin123" | chpasswd
echo "developer:developer" | chpasswd
echo "backup:backup" | chpasswd

# Install services
apt update
DEBIAN_FRONTEND=noninteractive apt install -y \
  samba \
  apache2 \
  mysql-server \
  net-tools \
  curl

# SMB misconfiguration
mkdir -p /srv/share
chmod 777 /srv/share
cat > /etc/samba/smb.conf << EOF
[public]
   path = /srv/share
   browsable = yes
   writable = yes
   guest ok = yes
   read only = no
EOF

systemctl restart smbd

# Apache internal app
mkdir -p /var/www/internal
cat > /var/www/internal/index.php << EOF
<?php
echo "<h1>Internal Admin Portal</h1>";
echo "<pre>";
echo "DB_USER=admin\\n";
echo "DB_PASS=admin123\\n";
echo "MYSQL_HOST=localhost\\n";
echo "</pre>";
?>
EOF

cat > /etc/apache2/sites-available/internal.conf << EOF
<VirtualHost *:8080>
  DocumentRoot /var/www/internal
</VirtualHost>
EOF

a2ensite internal.conf
echo "Listen 8080" >> /etc/apache2/ports.conf
systemctl restart apache2

# MySQL internal exposure
mysql -e "CREATE DATABASE internaldb;"
mysql -e "CREATE USER 'admin'@'%' IDENTIFIED BY 'admin123';"
mysql -e "GRANT ALL PRIVILEGES ON internaldb.* TO 'admin'@'%';"
mysql -e "FLUSH PRIVILEGES;"

# Firewall disabled (internal trust)
iptables -F || true

echo "PNPT INTERNAL READY"
echo "IP: 172.28.128.50"
echo "Services:"
echo "- SMB (445)"
echo "- Apache (8080)"
echo "- MySQL (3306, internal)"
SHELL
  end

  # ---------- Metasploitable2 ----------
  config.vm.define "metasploitable2" do |vm|
    vm.vm.box = "deargle/metasploitable2"
    vm.vm.hostname = "metasploitable2"
    configure_network(vm, "172.28.128.12")
    configure_libvirt(vm, nic_model_type: "virtio")
    
    vm.vm.synced_folder ".", "/vagrant", disabled: true
    vm.vm.communicator = "ssh"
    vm.ssh.insert_key = false
    vm.ssh.username = "msfadmin"
    vm.ssh.password = "msfadmin"
    vm.vm.boot_timeout = 600
    
    # Simple network config for Metasploitable
    vm.vm.provision "shell",
      run: "once",
      inline: <<-SHELL
#!/bin/bash
echo "nameserver 172.28.128.21" > /etc/resolv.conf
echo "search lab.local" >> /etc/resolv.conf
echo "172.28.128.21 dc01.lab.local dc01" >> /etc/hosts
echo "172.28.128.23 db01.lab.local db01" >> /etc/hosts
echo "172.28.128.30 win10.lab.local win10" >> /etc/hosts
echo "172.28.128.50 pnpt-internal.lab.local pnpt-internal" >> /etc/hosts
SHELL
  end

  # ---------- Metasploitable3 Ubuntu ----------
  config.vm.define "metasploitable3-ubuntu" do |vm|
    vm.vm.box = "rapid7/metasploitable3-ubuntu"
    vm.vm.hostname = "ms3-ubuntu"
    configure_network(vm, "172.28.128.13")
    configure_libvirt(vm, memory: 1024, nic_model_type: "virtio")  # DEFAULT: 1GB RAM
    
    # Network configuration
    vm.vm.provision "shell",
      run: "once",
      inline: <<-SHELL
#!/bin/bash
echo "nameserver 172.28.128.21" > /etc/resolv.conf
echo "search lab.local" >> /etc/resolv.conf
echo "172.28.128.21 dc01.lab.local dc01" >> /etc/hosts
echo "172.28.128.23 db01.lab.local db01" >> /etc/hosts
echo "172.28.128.30 win10.lab.local win10" >> /etc/hosts
echo "172.28.128.50 pnpt-internal.lab.local pnpt-internal" >> /etc/hosts
SHELL
  end

  # ---------- Metasploitable3 Windows ----------
  config.vm.define "metasploitable3-win2k8" do |vm|
    vm.vm.box = "tmarchst/metasploitable3-win2k8"
    vm.vm.hostname = "ms3-win2k8"
    vm.vm.synced_folder ".", "/vagrant", disabled: true
    configure_network(vm, "172.28.128.14")
    configure_libvirt(vm, WINDOWS_CONFIG.merge(memory: 2048, disk_size: 30))  # 2GB RAM, 30GB disk
    configure_windows_comm(vm, "vagrant", "vagrant")
  end

  # ---------- DOMAIN CONTROLLER (DC01) ----------
  config.vm.define "DC01", primary: true do |vm|
    vm.vm.box = "peru/windows-server-2022-standard-x64-eval"
    vm.vm.hostname = "DC01"
    vm.vm.boot_timeout = 7200
    vm.vm.synced_folder ".", "/vagrant", disabled: true

    # WINRM CONFIGURATION
    vm.vm.communicator = "winrm"
    vm.winrm.username = "vagrant"
    vm.winrm.password = "vagrant"  # ALWAYS use default password for Vagrant WinRM
    vm.winrm.transport = :plaintext
    vm.winrm.port = 5985
    vm.winrm.timeout = 7200
    vm.winrm.retry_limit = 240
    vm.winrm.retry_delay = 30
    vm.winrm.basic_auth_only = true

    # NETWORK CONFIGURATION
    configure_network(vm, DC_IP)
    configure_libvirt(vm, WINDOWS_CONFIG.merge(memory: 2048, disk_size: 40))  # REDUCED: 2GB RAM, 40GB disk

    # -----------------------------
    # PHASE 0: WINRM BOOTSTRAP
    # -----------------------------
    vm.vm.provision "shell",
      name: "phase0-winrm-bootstrap",
      privileged: false,
      run: "once",
      inline: <<-SHELL
        Write-Host 'PHASE 0: WINRM BOOTSTRAP'
        Set-Service WinRM -StartupType Automatic -ErrorAction SilentlyContinue
        Start-Service WinRM -ErrorAction SilentlyContinue
        winrm set winrm/config/service '@{AllowUnencrypted="true"}' 2>$null
        winrm set winrm/config/service/auth '@{Basic="true"}' 2>$null
        winrm set winrm/config/listener?Address=*+Transport=HTTP 2>$null
        netsh advfirewall firewall set rule group="Windows Remote Management" new enable=yes 2>$null
        Write-Host '[OK] WinRM bootstrap complete'
      SHELL

    # -----------------------------
    # PHASE 1: BASIC SETUP - DO NOT CHANGE LOCAL PASSWORD
    # -----------------------------
    vm.vm.provision "shell",
      name: "phase1-basic-setup",
      privileged: false,
      inline: <<-SHELL
        if (Test-Path 'C:\\DC-FINAL.txt') { exit 0 }
        Write-Host 'PHASE 1: BASIC SETUP'

        # IMPORTANT: DO NOT change local vagrant password
        # Keep it as default so Vagrant can always reconnect
        
        # Ensure vagrant user is active and admin
        net user vagrant /active:yes 2>$null
        net localgroup administrators vagrant /add 2>$null
        
        # Configure network and install AD features
        Get-NetConnectionProfile | Set-NetConnectionProfile -NetworkCategory Private 2>$null
        Install-WindowsFeature AD-Domain-Services, RSAT-AD-PowerShell, RSAT-ADDS -IncludeManagementTools 2>$null

        $adapter = Get-NetAdapter | Where-Object {$_.Status -eq 'Up'} | Select-Object -First 1
        if ($adapter) {
          Set-DnsClientServerAddress -InterfaceIndex $adapter.ifIndex -ServerAddresses '127.0.0.1' 2>$null
        }

        "Phase 1 completed" | Out-File C:\\PHASE1-COMPLETE.txt -Force
        Write-Host '[SUCCESS] Phase 1 complete!'
      SHELL

    vm.vm.provision :reload, name: "reboot-after-phase1"

    # -----------------------------
    # PHASE 2: POST-REBOOT VERIFICATION
    # -----------------------------
    vm.vm.provision "shell",
      name: "phase2-post-reboot-verification",
      privileged: false,
      inline: <<-SHELL
        if (Test-Path 'C:\\DC-FINAL.txt') { exit 0 }
        if (-not (Test-Path 'C:\\PHASE1-COMPLETE.txt')) { 
          Write-Host "Phase 1 not completed. Exiting."
          exit 1 
        }
        
        Write-Host 'PHASE 2: POST-REBOOT VERIFICATION'
        
        # Wait for system to stabilize after reboot
        Start-Sleep -Seconds 30
        
        # Ensure WinRM service is still running
        Set-Service WinRM -StartupType Automatic -ErrorAction SilentlyContinue
        Start-Service WinRM -ErrorAction SilentlyContinue
        
        # Reconfigure WinRM for AD promotion
        winrm quickconfig -quiet -force 2>$null
        winrm set winrm/config/service '@{AllowUnencrypted="true"}' 2>$null
        winrm set winrm/config/service/auth '@{Basic="true";Kerberos="true";Negotiate="true"}' 2>$null
        
        "Phase 2 completed" | Out-File C:\\PHASE2-COMPLETE.txt -Force
        Write-Host '[SUCCESS] Phase 2 complete - Ready for AD promotion'
      SHELL

    # -----------------------------
    # PHASE 3: AD PROMOTION
    # -----------------------------
    vm.vm.provision "shell",
      name: "phase3-ad-promotion",
      privileged: false,
      inline: <<-SHELL
        if (Test-Path 'C:\\DC-FINAL.txt') { exit 0 }
        if (-not (Test-Path 'C:\\PHASE2-COMPLETE.txt')) { 
          Write-Host "Phase 2 not completed. Exiting."
          exit 1 
        }

        Write-Host 'PHASE 3: AD PROMOTION'

        # Import the module
        Import-Module ADDSDeployment -ErrorAction SilentlyContinue
        if (-not (Get-Module ADDSDeployment)) {
          Add-WindowsFeature AD-Domain-Services -IncludeManagementTools 2>$null
          Import-Module ADDSDeployment
        }

        $safeModePass = ConvertTo-SecureString 'Passw0rd!' -AsPlainText -Force

        # PROMOTE DC
        try {
          Install-ADDSForest `
            -DomainName "#{DOMAIN_NAME}" `
            -DomainNetbiosName "#{DOMAIN_NETBIOS}" `
            -InstallDNS `
            -SafeModeAdministratorPassword $safeModePass `
            -Force `
            -NoRebootOnCompletion

          Write-Host '[SUCCESS] AD promotion complete!'
        } catch {
          Write-Error "AD promotion failed: $_"
          Write-Error "Check logs for details."
          exit 1
        }

        # Mark promotion done
        "AD promoted" | Out-File C:\\AD-PROMOTED.txt -Force

        # Reboot for completion
        Write-Host 'Rebooting in 10 seconds...'
        shutdown /r /t 10 /f
      SHELL

    vm.vm.provision :reload, name: "reboot-after-ad-promotion"

    # -----------------------------
    # WINRM STABILIZER AFTER AD PROMOTION
    # -----------------------------
    vm.vm.provision "shell",
      name: "post-ad-winrm-stabilizer",
      privileged: true,
      inline: <<-SHELL
        Write-Host "Stabilizing WinRM after AD promotion..."
        Start-Sleep -Seconds 60
        Set-Service WinRM -StartupType Automatic
        Start-Service WinRM
        Write-Host "[OK] WinRM stabilized after AD promotion"
      SHELL

    # -----------------------------
    # PHASE 4+5: FULL DC CONFIGURATION - FIXED VERSION
    # -----------------------------
    vm.vm.provision "shell",
      name: "phase4-5-full-dc-config",
      privileged: true,
      inline: <<-SHELL
        if (Test-Path "C:\\DC-FINAL.txt") { 
          Write-Host "DC already fully configured. Skipping Phase 4+5."
          exit 0
        }
        if (-not (Test-Path "C:\\AD-PROMOTED.txt")) {
          Write-Host "AD promotion not detected. Exiting full DC configuration."
          Write-Host "[INFO] Phase failed but continuing to allow recovery"
          exit 0
        }

        Write-Host "PHASE 4+5: FULL DC CONFIGURATION"

        # Wait for system to stabilize after reboot
        Write-Host "[*] Waiting for AD to stabilize..."
        Start-Sleep -Seconds 60

        Import-Module ActiveDirectory -ErrorAction Stop

        # Dynamically build domain DN for any domain length
        $domainParts = "#{DOMAIN_NAME}".Split('.')
        $domainDN = ($domainParts | ForEach-Object { "DC=$_" }) -join ','

        # -----------------------------
        # Wait for AD DS services to be ready
        # -----------------------------
        $attempt = 0
        $maxAttempts = 30
        $domainCheck = $null
        
        while ($attempt -lt $maxAttempts) {
          $attempt++
          try {
            $domainCheck = Get-ADDomain -ErrorAction Stop
            if ($domainCheck) { 
              Write-Host "AD Domain detected: $($domainCheck.Name) (attempt $attempt/$maxAttempts)"
              break 
            }
          } catch {
            Write-Host "Waiting for AD Domain Services to be ready... attempt $attempt/$maxAttempts"
            Start-Sleep -Seconds 30
          }
        }

        if (-not $domainCheck) {
          Write-Host "[WARNING] Cannot detect AD Domain after $maxAttempts attempts. Continuing anyway."
        }

        # -----------------------------
        # Ensure LAB OU and sub-OUs exist
        # -----------------------------
        try {
          $labOU = "OU=LAB,$domainDN"
          if (-not (Get-ADOrganizationalUnit -Filter "Name -eq 'LAB'" -ErrorAction SilentlyContinue)) {
            New-ADOrganizationalUnit -Name "LAB" -Path $domainDN -ErrorAction Stop
            Write-Host "[OK] Created LAB OU"
          } else {
            Write-Host "[OK] LAB OU already exists"
          }

          foreach ($subOU in @("Users","Groups","Computers","ServiceAccounts")) {
            $path = "OU=$subOU,$labOU"
            if (-not (Get-ADOrganizationalUnit -Filter "Name -eq '$subOU'" -SearchBase $labOU -ErrorAction SilentlyContinue)) {
              New-ADOrganizationalUnit -Name $subOU -Path $labOU -ErrorAction Stop
              Write-Host "[OK] Created $subOU OU"
            } else {
              Write-Host "[OK] $subOU OU already exists"
            }
          }
        } catch {
          Write-Host "[ERROR] Failed to create LAB or sub-OUs: $_"
        }

        # -----------------------------
        # Ensure WinRM is running
        # -----------------------------
        Set-Service WinRM -StartupType Automatic
        Start-Service WinRM
        winrm set winrm/config/service '@{AllowUnencrypted="true"}' 2>$null
        winrm set winrm/config/service/auth '@{Basic="true"}' 2>$null
        winrm set winrm/config/listener?Address=*+Transport=HTTP 2>$null
        Write-Host "[OK] WinRM configured for domain communication"

        # -----------------------------
        # Create vagrant DOMAIN user (separate from local user)
        # -----------------------------
        if (-not (Get-ADUser -LDAPFilter "(sAMAccountName=vagrant)" -ErrorAction SilentlyContinue)) {
          $pass = ConvertTo-SecureString "#{VAGRANT_UPDATED_PASSWORD}" -AsPlainText -Force
          New-ADUser -Name "vagrant" -SamAccountName "vagrant" -AccountPassword $pass -Enabled $true -Path "OU=Users,$labOU"
          Add-ADGroupMember "Domain Admins" vagrant
          Write-Host "[OK] Created vagrant domain user in Users OU"
        } else {
          Write-Host "[OK] vagrant domain user already exists"
        }

        # -----------------------------
        # Set known password for built-in Administrator account
        # -----------------------------
        try {
          $adminPass = ConvertTo-SecureString "Passw0rd!" -AsPlainText -Force
          Set-ADAccountPassword -Identity "Administrator" -NewPassword $adminPass -Reset
          Enable-ADAccount -Identity "Administrator"
          Write-Host "[OK] Set password for built-in Administrator account"
        } catch {
          Write-Host "[INFO] Could not set Administrator password: $_"
        }

        # -----------------------------
        # Create test users
        # -----------------------------
        $users = @(
          @{Name="Alice Adams"; SamAccountName="alice.adams"},
          @{Name="Bob Builder"; SamAccountName="bob.builder"},
          @{Name="Dave Evans"; SamAccountName="dave.evans"}
        )

        foreach ($user in $users) {
          $sam = $user.SamAccountName
          
          if (-not (Get-ADUser -LDAPFilter "(sAMAccountName=$sam)" -ErrorAction SilentlyContinue)) {
            $pass = ConvertTo-SecureString "Passw0rd!" -AsPlainText -Force
            New-ADUser -Name $user.Name -SamAccountName $user.SamAccountName -AccountPassword $pass -Enabled $true -Path "OU=Users,$labOU"
            Write-Host "Created user: $($user.SamAccountName)"
          } else {
            Write-Host "User already exists: $($user.SamAccountName)"
          }
        }

        # -----------------------------
        # Service account for domain joins
        # -----------------------------
        if (-not (Get-ADUser -LDAPFilter "(sAMAccountName=#{DOMAIN_JOIN_USER})" -ErrorAction SilentlyContinue)) {
          $pass = ConvertTo-SecureString "#{DOMAIN_JOIN_PASS}" -AsPlainText -Force
          New-ADUser -Name "Service Join Account" -SamAccountName "#{DOMAIN_JOIN_USER}" -AccountPassword $pass -Enabled $true -Path "OU=ServiceAccounts,$labOU"
          Add-ADGroupMember "Domain Admins" "#{DOMAIN_JOIN_USER}"
          Write-Host "[OK] Created #{DOMAIN_JOIN_USER} service account"
        } else {
          Write-Host "[OK] #{DOMAIN_JOIN_USER} service account already exists"
        }

        # -----------------------------
        # PJPT FULL LAB CONFIGURATION
        # -----------------------------
        Write-Host "============================================================"
        Write-Host " CONFIGURING PJPT FULL ACTIVE DIRECTORY LAB "
        Write-Host " Domain: #{DOMAIN_NAME}"
        Write-Host " Purpose: Offensive AD / PJPT / CRTP-style practice lab"
        Write-Host "============================================================"

        # -----------------------------------------------------------
        # VARIABLES
        # -----------------------------------------------------------
        $pjptRootOU = "OU=CORP,$labOU"
        $pjptUserOU = "OU=Users,$pjptRootOU"
        $pjptGroupOU = "OU=Groups,$pjptRootOU"
        $pjptSvcOU = "OU=ServiceAccounts,$pjptRootOU"

        $WeakPass = ConvertTo-SecureString "Passw0rd!" -AsPlainText -Force
        $SvcPass1 = ConvertTo-SecureString "ServiceP@ss1" -AsPlainText -Force
        $SvcPass2 = ConvertTo-SecureString "ServiceP@ss2" -AsPlainText -Force
        $SvcPass3 = ConvertTo-SecureString "ServiceP@ss3" -AsPlainText -Force

        # -----------------------------------------------------------
        # CREATE CORP OU STRUCTURE
        # -----------------------------------------------------------
        Write-Host "[*] Creating CORP OU structure..."

        # Create CORP OU under LAB OU
        New-ADOrganizationalUnit -Name "CORP" -Path $labOU -ErrorAction SilentlyContinue
        "Users","Groups","Computers","ServiceAccounts" | ForEach-Object {
            New-ADOrganizationalUnit -Name $_ -Path $pjptRootOU -ErrorAction SilentlyContinue
        }

        Write-Host "[OK] OU structure: LAB -> CORP -> [Users, Groups, Computers, ServiceAccounts]"
        Start-Sleep -Seconds 10  # Let AD catch up

        # -----------------------------------------------------------
        # CREATE VULNERABLE GROUPS WITH DISTINGUISHED NAMES
        # -----------------------------------------------------------
        Write-Host "[*] Creating vulnerable groups..."

        $Groups = @(
            @{Name="IT Support"; Path=$pjptGroupOU; SamName="ITSupport"},
            @{Name="Helpdesk"; Path=$pjptGroupOU; SamName="Helpdesk"},
            @{Name="Developers"; Path=$pjptGroupOU; SamName="Developers"},
            @{Name="HR"; Path=$pjptGroupOU; SamName="HR"},
            @{Name="Finance"; Path=$pjptGroupOU; SamName="Finance"},
            @{Name="Legacy-Admins"; Path=$pjptGroupOU; SamName="LegacyAdmins"}
        )

        $groupDNs = @{}
        
        foreach ($g in $Groups) {
            if (-not (Get-ADGroup -Filter "Name -eq '$($g.Name)'" -SearchBase $pjptGroupOU -ErrorAction SilentlyContinue)) {
                New-ADGroup `
                    -Name $g.Name `
                    -SamAccountName $g.SamName `
                    -GroupScope Global `
                    -GroupCategory Security `
                    -Path $g.Path `
                    -ErrorAction SilentlyContinue
                Write-Host "[OK] Created group: $($g.Name)"
            } else {
                Write-Host "[OK] Group already exists: $($g.Name)"
            }
            
            # Store the Distinguished Name for later use
            $groupObj = Get-ADGroup -Filter "Name -eq '$($g.Name)'" -SearchBase $pjptGroupOU -ErrorAction SilentlyContinue
            if ($groupObj) {
                $groupDNs[$g.Name] = $groupObj.DistinguishedName
            }
        }

        # -----------------------------------------------------------
        # CREATE AND ADD USERS TO GROUPS
        # -----------------------------------------------------------
        Write-Host "[*] Creating users with group memberships..."

        $UserGroups = @(
            @{User="alice.adams"; Group="Helpdesk"},
            @{User="bob.builder"; Group="IT Support"},
            @{User="dave.evans"; Group="Developers"}
        )

        foreach ($entry in $UserGroups) {
            $u = $entry.User
            $groupName = $entry.Group
            
            # Get user if exists
            $userObj = Get-ADUser -Filter "SamAccountName -eq '$u'" -ErrorAction SilentlyContinue
            if (-not $userObj) {
                Write-Host "[WARNING] User $u not found, skipping group assignment"
                continue
            }
            
            # Check if we have the group DN
            if (-not $groupDNs.ContainsKey($groupName)) {
                Write-Host "[WARNING] Group $groupName not found in our list, skipping"
                continue
            }
            
            $groupDN = $groupDNs[$groupName]
            
            # Add user to group using Distinguished Name
            try {
                Add-ADGroupMember -Identity $groupDN -Members $userObj -ErrorAction Stop
                Write-Host "[OK] Added $u to $groupName group"
            } catch {
                Write-Host "[INFO] $u might already be member of $groupName. Error details: $_"
            }
        }

        # -----------------------------------------------------------
        # CREATE VULNERABLE SERVICE ACCOUNTS
        # -----------------------------------------------------------
        Write-Host "[*] Creating vulnerable service accounts..."

        # AS-REP Roasting account
        if (-not (Get-ADUser -LDAPFilter "(sAMAccountName=svc_asrep)" -ErrorAction SilentlyContinue)) {
            New-ADUser -Name "svc_asrep" -SamAccountName "svc_asrep" `
                -AccountPassword $SvcPass1 `
                -Enabled $true `
                -PasswordNeverExpires $true `
                -Path $pjptSvcOU `
                -ErrorAction SilentlyContinue
            Write-Host "[OK] Created svc_asrep account"
            
            # Enable AS-REP roasting using direct attribute modification
            Set-ADUser "svc_asrep" -Replace @{userAccountControl = 4194304} -ErrorAction SilentlyContinue
            Write-Host "[OK] Enabled AS-REP roasting on svc_asrep"
        }

        # Kerberoasting account
        if (-not (Get-ADUser -LDAPFilter "(sAMAccountName=svc_kerberoast)" -ErrorAction SilentlyContinue)) {
            New-ADUser -Name "svc_kerberoast" -SamAccountName "svc_kerberoast" `
                -AccountPassword $SvcPass2 `
                -Enabled $true `
                -PasswordNeverExpires $true `
                -Path $pjptSvcOU `
                -ErrorAction SilentlyContinue
            Write-Host "[OK] Created svc_kerberoast account"

            # Add SPNs for realistic Kerberoasting
            $spns = @(
                "MSSQLSvc/DB01.#{DOMAIN_NAME}",
                "MSSQLSvc/DB01.#{DOMAIN_NAME}:1433",
                "MSSQLSvc/DB01.#{DOMAIN_NAME}\\SQLEXPRESS"
            )
            
            foreach ($spn in $spns) {
                setspn -A $spn "svc_kerberoast" 2>$null
            }
            Write-Host "[OK] Added SPNs to svc_kerberoast for Kerberoasting"
        }

        # Delegation abuse account
        if (-not (Get-ADUser -LDAPFilter "(sAMAccountName=svc_delegate)" -ErrorAction SilentlyContinue)) {
            New-ADUser -Name "svc_delegate" -SamAccountName "svc_delegate" `
                -AccountPassword $SvcPass3 `
                -Enabled $true `
                -PasswordNeverExpires $true `
                -Path $pjptSvcOU `
                -ErrorAction SilentlyContinue
            Write-Host "[OK] Created svc_delegate account"

            # Configure classic constrained delegation
            Set-ADUser svc_delegate -TrustedForDelegation $true -ErrorAction SilentlyContinue
            Set-ADUser svc_delegate -Add @{'msDS-AllowedToDelegateTo'=@("MSSQLSvc/DB01.#{DOMAIN_NAME}","MSSQLSvc/DB01.#{DOMAIN_NAME}:1433")} -ErrorAction SilentlyContinue
            Write-Host "[OK] Configured constrained delegation for svc_delegate"
        }

        # -----------------------------------------------------------
        # CREATE PRIVILEGE ESCALATION CHAINS
        # -----------------------------------------------------------
        Write-Host "[*] Creating privilege escalation paths..."
        Start-Sleep -Seconds 10  # Let groups propagate

        # Add groups to high-privilege groups using DNs
        try {
            if ($groupDNs.ContainsKey("IT Support")) {
                $itSupportDN = $groupDNs["IT Support"]
                Add-ADGroupMember "Domain Admins" -Members $itSupportDN -ErrorAction SilentlyContinue
                Write-Host "[OK] Added IT Support to Domain Admins"
            }
        } catch {
            Write-Host "[INFO] Could not add IT Support to Domain Admins"
        }

        try {
            if ($groupDNs.ContainsKey("Legacy-Admins")) {
                $legacyAdminsDN = $groupDNs["Legacy-Admins"]
                Add-ADGroupMember "Enterprise Admins" -Members $legacyAdminsDN -ErrorAction SilentlyContinue
                Write-Host "[OK] Added Legacy-Admins to Enterprise Admins"
            }
        } catch {
            Write-Host "[INFO] Could not add Legacy-Admins to Enterprise Admins"
        }

        # BloodHound ACL path
        try {
            if ($groupDNs.ContainsKey("Helpdesk")) {
                $helpdeskDN = $groupDNs["Helpdesk"]
                $helpdeskSamName = (Get-ADGroup -Identity $helpdeskDN).SamAccountName
                dsacls "CN=Domain Admins,CN=Users,$domainDN" /G "#{DOMAIN_NETBIOS}\\$helpdeskSamName:GA" | Out-Null
                Write-Host "[OK] Set DACL: Helpdesk -> Domain Admins (Full Control)"
            }
        } catch {
            Write-Host "[INFO] Could not set DACL on Domain Admins: $_"
        }

        # -----------------------------------------------------------
        # WEAKEN AdminSDHolder
        # -----------------------------------------------------------
        Write-Host "[*] Weakening AdminSDHolder..."

        try {
            if ($groupDNs.ContainsKey("Developers")) {
                $devGroupDN = $groupDNs["Developers"]
                $devSamName = (Get-ADGroup -Identity $devGroupDN).SamAccountName
                dsacls "CN=AdminSDHolder,CN=System,$domainDN" /G "#{DOMAIN_NETBIOS}\\$devSamName:GA" | Out-Null
                Write-Host "[OK] Set DACL: Developers -> AdminSDHolder (Full Control)"
            }
        } catch {
            Write-Host "[INFO] Could not weaken AdminSDHolder: $_"
        }

        # -----------------------------------------------------------
        # PLANT GPP CPASSWORD IN SYSVOL
        # -----------------------------------------------------------
        Write-Host "[*] Planting GPP cpassword in SYSVOL..."

        $gppPath = "C:\\Windows\\SYSVOL\\sysvol\\#{DOMAIN_NAME}\\Policies\\{31B2F340-016D-11D2-945F-00C04FB984F9}\\Machine\\Preferences\\Groups"
        New-Item -ItemType Directory -Force -Path $gppPath -ErrorAction SilentlyContinue | Out-Null

        # GPP XML
        $gppXml = @'
<?xml version="1.0" encoding="utf-8"?>
<Groups clsid="{3125E937-EB16-4b4c-9934-544FC6D24D26}">
  <User clsid="{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}" name="LocalAdmin"
        image="2" changed="2024-01-01 12:00:00" uid="{E126A7D4-B6F4-4C7A-9815-9F0F6E5E3B1C}">
    <Properties action="U" newName="" fullName="" description=""
                cpassword="gM7F9mQzK4+XH8EJZkP8iA==" changeLogon="0"
                noChange="0" neverExpires="1" acctDisabled="0"
                subAuthority="RID_ADMIN" userName="LocalAdmin"/>
  </User>
</Groups>
'@

        $gppXml | Out-File "$gppPath\\Groups.xml" -Encoding UTF8 -Force
        Write-Host "[OK] GPP Groups.xml planted (cpassword: gM7F9mQzK4+XH8EJZkP8iA== decodes to 'Passw0rd!')"

        # -----------------------------------------------------------
        # DISABLE SMB SIGNING FOR RELAY ATTACKS
        # -----------------------------------------------------------
        Write-Host "[*] Disabling SMB signing on DC for relay attacks..."
        Set-ItemProperty `
            -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters" `
            -Name RequireSecuritySignature `
            -Value 0 `
            -Force `
            -ErrorAction SilentlyContinue
        Write-Host "[OK] SMB signing disabled for relay attacks"

        # -----------------------------------------------------------
        # CREATE WEAK FILE SHARE
        # -----------------------------------------------------------
        Write-Host "[*] Creating weak SMB share..."

        New-Item -ItemType Directory -Path "C:\\Public" -Force -ErrorAction SilentlyContinue | Out-Null
        New-SmbShare -Name "Public" -Path "C:\\Public" -FullAccess "Everyone" -ErrorAction SilentlyContinue
        Write-Host "[OK] Created weak SMB share 'Public' with Everyone access"

        # -----------------------------------------------------------
        # CREATE STATIC DNS ENTRIES FOR LAB MACHINES
        # -----------------------------------------------------------
        Write-Host "[*] Creating static DNS entries..."
        
        try {
            # DB01
            Add-DnsServerResourceRecordA -Name "DB01" -ZoneName "#{DOMAIN_NAME}" -IPv4Address "172.28.128.23" -ErrorAction SilentlyContinue
            # WIN10
            Add-DnsServerResourceRecordA -Name "WIN10" -ZoneName "#{DOMAIN_NAME}" -IPv4Address "172.28.128.30" -ErrorAction SilentlyContinue
            # DC01 (already exists)
            Add-DnsServerResourceRecordA -Name "DC01" -ZoneName "#{DOMAIN_NAME}" -IPv4Address "#{DC_IP}" -ErrorAction SilentlyContinue
            # CA01 - ADDED FOR CERTIPY/ESC ATTACKS
            Add-DnsServerResourceRecordA -Name "CA01" -ZoneName "#{DOMAIN_NAME}" -IPv4Address "172.28.128.24" -ErrorAction SilentlyContinue
            
            # NEW TARGETS
            Add-DnsServerResourceRecordA -Name "pentestplus-target" -ZoneName "#{DOMAIN_NAME}" -IPv4Address "172.28.128.16" -ErrorAction SilentlyContinue
            Add-DnsServerResourceRecordA -Name "pjpt-target" -ZoneName "#{DOMAIN_NAME}" -IPv4Address "172.28.128.17" -ErrorAction SilentlyContinue
            Add-DnsServerResourceRecordA -Name "oscp-target" -ZoneName "#{DOMAIN_NAME}" -IPv4Address "172.28.128.18" -ErrorAction SilentlyContinue
            Add-DnsServerResourceRecordA -Name "cloud-pentest" -ZoneName "#{DOMAIN_NAME}" -IPv4Address "172.28.128.19" -ErrorAction SilentlyContinue
            Add-DnsServerResourceRecordA -Name "pnpt-internal" -ZoneName "#{DOMAIN_NAME}" -IPv4Address "172.28.128.50" -ErrorAction SilentlyContinue
            
            Write-Host "[OK] Static DNS entries created"
        } catch {
            Write-Host "[INFO] DNS entries already exist or couldn't be created: $_"
        }

        # -----------------------------------------------------------
        # CREATE ADCS VULNERABLE TEMPLATES ON DC
        # -----------------------------------------------------------
        Write-Host "[*] Creating ADCS vulnerable templates on DC..."
        
        try {
            $configNC = (Get-ADRootDSE).configurationNamingContext
            $templatePath = "CN=Certificate Templates,CN=Public Key Services,CN=Services,$configNC"
            
            # Check if template already exists
            if (-not (Get-ADObject -Filter "name -eq 'VulnESC1'" -SearchBase $templatePath -ErrorAction SilentlyContinue)) {
                
                # Create ESC1 template
                New-ADObject `
                    -Type pKICertificateTemplate `
                    -Name "VulnESC1" `
                    -Path $templatePath `
                    -OtherAttributes @{
                        displayName = "VulnESC1";
                        pKIExpirationPeriod = "172800000000000";
                        pKIOverlapPeriod = "8640000000000";
                        pKIMaxIssuingDepth = 0;
                        pKICriticalExtensions = "2.5.29.15";
                        pKIDefaultKeySpec = 1;
                        pKIKeyUsage = 160;
                        pKIExtendedKeyUsage = "1.3.6.1.5.5.7.3.2";
                        msPKI_RA_Signature = 0;
                        msPKI_Enrollment_Flag = 32;
                        msPKI_Private_Key_Flag = 16842752;
                        msPKI_Certificate_Name_Flag = 1;
                        msPKI_Minimal_Key_Size = 1024;
                        msPKI_Template_Schema_Version = 2;
                        msPKI_Template_Minor_Revision = 2;
                    }
                
                Write-Host "[OK] Created VulnESC1 template for AD CS attacks"
                
                # Also create a vulnerable WebServer template
                if (-not (Get-ADObject -Filter "name -eq 'VulnWebServer'" -SearchBase $templatePath -ErrorAction SilentlyContinue)) {
                    New-ADObject `
                        -Type pKICertificateTemplate `
                        -Name "VulnWebServer" `
                        -Path $templatePath `
                        -OtherAttributes @{
                            displayName = "VulnWebServer";
                            pKIExpirationPeriod = "172800000000000";
                            pKIOverlapPeriod = "8640000000000";
                            pKIMaxIssuingDepth = 0;
                            pKICriticalExtensions = "2.5.29.15";
                            pKIDefaultKeySpec = 1;
                            pKIKeyUsage = 160;
                            pKIExtendedKeyUsage = "1.3.6.1.5.5.7.3.1";
                            msPKI_RA_Signature = 0;
                            msPKI_Enrollment_Flag = 32;
                            msPKI_Private_Key_Flag = 16842752;
                            msPKI_Certificate_Name_Flag = 1;
                            msPKI_Minimal_Key_Size = 1024;
                        }
                    Write-Host "[OK] Created VulnWebServer template"
                }
                
                # Create ESC6-like template (no enrollment restrictions)
                if (-not (Get-ADObject -Filter "name -eq 'VulnESC6'" -SearchBase $templatePath -ErrorAction SilentlyContinue)) {
                    New-ADObject `
                        -Type pKICertificateTemplate `
                        -Name "VulnESC6" `
                        -Path $templatePath `
                        -OtherAttributes @{
                            displayName = "VulnESC6";
                            pKIExpirationPeriod = "172800000000000";
                            pKIOverlapPeriod = "8640000000000";
                            pKIMaxIssuingDepth = 0;
                            pKICriticalExtensions = "2.5.29.15";
                            pKIDefaultKeySpec = 1;
                            pKIKeyUsage = 160;
                            pKIExtendedKeyUsage = "1.3.6.1.5.5.7.3.2,1.3.6.1.5.5.7.3.1";
                            msPKI_RA_Signature = 0;
                            msPKI_Enrollment_Flag = 32;
                            msPKI_Private_Key_Flag = 16842752;
                            msPKI_Certificate_Name_Flag = 1;
                            msPKI_Minimal_Key_Size = 1024;
                            msPKI_Cert_Template_OID = "1.3.6.1.4.1.311.21.8.14232239.12712465.13440235.9474106.4474492.200.1.6";
                        }
                    Write-Host "[OK] Created VulnESC6 template (no enrollment restrictions)"
                }
            } else {
                Write-Host "[OK] AD CS templates already exist"
            }
        } catch {
            Write-Host "[INFO] Could not create AD CS templates: $_"
            Write-Host "[INFO] This is non-critical - AD CS lab setup will continue on CA01"
        }

        # -----------------------------------------------------------
        # FINAL VALIDATION
        # -----------------------------------------------------------
        Write-Host "[*] Running DC diagnostics..."
        dcdiag /q 2>$null

        Write-Host ""
        Write-Host "=============================================="
        Write-Host " PJPT FULL LAB BUILD COMPLETE "
        Write-Host " Domain: #{DOMAIN_NAME}"
        Write-Host " Ready for BloodHound / CME / Impacket / Certipy"
        Write-Host "=============================================="

        # -----------------------------
        # Final completion flag
        # -----------------------------
        "DC01 fully configured at $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File C:\\DC-FINAL.txt -Force

        Write-Host "==========================================="
        Write-Host "DOMAIN CONTROLLER CONFIGURATION COMPLETE!"
        Write-Host "==========================================="
        Write-Host "Domain: #{DOMAIN_NAME}"
        Write-Host "DC IP: #{DC_IP}"
        Write-Host "Local Admin (for Vagrant): vagrant / vagrant"
        Write-Host "Domain Admin: vagrant / #{VAGRANT_UPDATED_PASSWORD}"
        Write-Host "Built-in Administrator: Administrator / Passw0rd!"
        Write-Host "Test Users: alice.adams / bob.builder / dave.evans (Passw0rd!)"
        Write-Host "Service Account for Domain Joins: #{DOMAIN_JOIN_USER} / #{DOMAIN_JOIN_PASS}"
        Write-Host ""
        Write-Host "PJPT Lab Accounts:"
        Write-Host "  svc_asrep / ServiceP@ss1 (AS-REP Roasting)"
        Write-Host "  svc_kerberoast / ServiceP@ss2 (Kerberoasting)"
        Write-Host "  svc_delegate / ServiceP@ss3 (Delegation - Classic Constrained)"
        Write-Host "  Helpdesk -> Domain Admins ACL abuse"
        Write-Host "  Developers -> AdminSDHolder ACL abuse"
        Write-Host "  GPP Password: LocalAdmin / Passw0rd! (cpassword)"
        Write-Host ""
        Write-Host "AD CS Templates Created:"
        Write-Host "  VulnESC1 - For ESC1-style attacks"
        Write-Host "  VulnWebServer - For web server certificates"
        Write-Host "  VulnESC6 - For enrollment restriction bypass"
        Write-Host ""
        Write-Host "DNS Records:"
        Write-Host "  DC01.lab.local -> 172.28.128.21"
        Write-Host "  DB01.lab.local -> 172.28.128.23"
        Write-Host "  WIN10.lab.local -> 172.28.128.30"
        Write-Host "  CA01.lab.local -> 172.28.128.24"
        Write-Host "  pentestplus-target.lab.local -> 172.28.128.16"
        Write-Host "  pjpt-target.lab.local -> 172.28.128.17"
        Write-Host "  oscp-target.lab.local -> 172.28.128.18"
        Write-Host "  cloud-pentest.lab.local -> 172.28.128.19"
        Write-Host "  pnpt-internal.lab.local -> 172.28.128.50"
        Write-Host "==========================================="
        Write-Host ""
        Write-Host "NEXT: You can now provision other VMs:"
        Write-Host "  vagrant up WIN10"
        Write-Host "  vagrant up DB01"
        Write-Host "  vagrant up CA01 (for AD CS / Certipy ESC attacks)"
        Write-Host "  vagrant up pentestplus-target"
        Write-Host "  vagrant up pjpt-target"
        Write-Host "  vagrant up oscp-target"
        Write-Host "  vagrant up cloud-pentest"
        Write-Host "  vagrant up pnpt-internal"
        Write-Host "==========================================="
        
        exit 0
      SHELL
  end

  # ============================================================
  # WINDOWS 10 CLIENT
  # ============================================================
  config.vm.define "WIN10" do |vm|
    vm.vm.box = "peru/windows-10-enterprise-x64-eval"
    vm.vm.hostname = "WIN10"
    vm.vm.synced_folder ".", "/vagrant", disabled: true
    
    vm.vm.communicator = "winrm"
    vm.winrm.username = "vagrant"
    vm.winrm.password = "vagrant"  # WIN10 box uses default password
    vm.winrm.transport = :plaintext
    vm.winrm.port = 5985
    vm.winrm.timeout = 600

    configure_network(vm, "172.28.128.30")
    configure_libvirt(vm, WINDOWS_CONFIG.merge(memory: 2048, disk_size: 30))  # REDUCED: 2GB RAM, 30GB disk
    wait_for_dc(vm)

    vm.vm.provision "shell",
      name: "domain-join",
      privileged: true,
      reboot: "always",
      inline: <<-SHELL
        Write-Host "=============================================="
        Write-Host " WIN10 CLIENT DOMAIN JOIN "
        Write-Host "=============================================="
        
        # Set DNS to DC01 on vagrant0 network
        $adapter = Get-NetAdapter | Where-Object {$_.Status -eq 'Up'} | Select-Object -First 1
        if ($adapter) {
          Set-DnsClientServerAddress -InterfaceIndex $adapter.ifIndex -ServerAddresses '#{DC_IP}'
          Write-Host "[OK] DNS set to DC01 (#{DC_IP})"
        }
        
        $sec = ConvertTo-SecureString '#{DOMAIN_JOIN_PASS}' -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential('#{DOMAIN_NETBIOS}\\#{DOMAIN_JOIN_USER}', $sec)
        
        # Try domain join with retry logic
        $maxAttempts = 3
        $attempt = 0
        $joined = $false
        
        while ($attempt -lt $maxAttempts -and -not $joined) {
          $attempt++
          try {
            Write-Host "[*] Domain join attempt $attempt of $maxAttempts..."
            Add-Computer -DomainName "#{DOMAIN_NAME}" -Credential $cred -Force -ErrorAction Stop
            $joined = $true
            Write-Host "[SUCCESS] Domain join completed"
          } catch {
            Write-Host "Domain join attempt $attempt failed: $_"
            if ($attempt -lt $maxAttempts) {
              Write-Host "Retrying in 30 seconds..."
              Start-Sleep -Seconds 30
            }
          }
        }
        
        if (-not $joined) {
          Write-Error "Failed to join domain after $maxAttempts attempts"
          exit 1
        }
        
        Rename-Computer -NewName 'WIN10' -Force
        Write-Host "[OK] Computer renamed to WIN10"
      SHELL
  end

  # ============================================================
  # DATABASE SERVER (DB01) - WITH PJPT VULNERABILITIES
  # ============================================================
  config.vm.define "DB01" do |vm|
    vm.vm.box = "peru/windows-server-2019-standard-x64-eval"
    vm.vm.hostname = "DB01"
    vm.vm.synced_folder ".", "/vagrant", disabled: true
    
    vm.vm.communicator = "winrm"
    vm.winrm.username = "vagrant"
    vm.winrm.password = "vagrant"  # DB01 box uses default password
    vm.winrm.transport = :plaintext
    vm.winrm.port = 5985
    vm.winrm.timeout = 600

    configure_network(vm, "172.28.128.23")
    configure_libvirt(vm, WINDOWS_CONFIG.merge(memory: 4096, disk_size: 40))  # REDUCED: 4GB RAM, 40GB disk
    wait_for_dc(vm)

    vm.vm.provision "shell",
      name: "domain-join-and-pjpt-vulnerabilities",
      privileged: true,
      inline: <<-SHELL
        Write-Host "=============================================="
        Write-Host " DB01 VULNERABLE MEMBER SERVER CONFIGURATION "
        Write-Host " Purpose: Kerberoast, Lateral Movement, NTLM Relay"
        Write-Host "=============================================="

        # -----------------------------
        # DOMAIN JOIN
        # -----------------------------
        # Set DNS to DC01 on vagrant0 network
        $adapter = Get-NetAdapter | Where-Object {$_.Status -eq 'Up'} | Select-Object -First 1
        if ($adapter) {
          Set-DnsClientServerAddress -InterfaceIndex $adapter.ifIndex -ServerAddresses '#{DC_IP}'
          Write-Host "[OK] DNS set to DC01 (#{DC_IP})"
        }
        
        $sec = ConvertTo-SecureString '#{DOMAIN_JOIN_PASS}' -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential('#{DOMAIN_NETBIOS}\\#{DOMAIN_JOIN_USER}', $sec)
        
        # Try domain join with retry logic
        $maxAttempts = 3
        $attempt = 0
        $joined = $false
        
        while ($attempt -lt $maxAttempts -and -not $joined) {
          $attempt++
          try {
            Write-Host "[*] Domain join attempt $attempt of $maxAttempts..."
            Add-Computer -DomainName "#{DOMAIN_NAME}" -Credential $cred -Force -ErrorAction Stop
            $joined = $true
            Write-Host "[SUCCESS] Domain join completed"
          } catch {
            Write-Host "Domain join attempt $attempt failed: $_"
            if ($attempt -lt $maxAttempts) {
              Write-Host "Retrying in 30 seconds..."
              Start-Sleep -Seconds 30
            }
          }
        }
        
        if (-not $joined) {
          Write-Error "Failed to join domain after $maxAttempts attempts"
          exit 1
        }
        
        Rename-Computer -NewName 'DB01' -Force
        Write-Host "[OK] Computer renamed to DB01"
        
        Write-Host "[*] Rebooting for domain join to take effect..."
        shutdown /r /t 5 /f
      SHELL

    vm.vm.provision :reload, name: "reboot-after-domain-join"

    vm.vm.provision "shell",
      name: "pjpt-vulnerabilities-config",
      privileged: true,
      inline: <<-SHELL
        Write-Host "[*] Configuring DB01 vulnerable settings..."

        # -----------------------------------------------------------
        # LOCAL ADMIN REUSE (LATERAL MOVEMENT) - IDEMPOTENT
        # -----------------------------------------------------------
        if (-not (Get-LocalUser -Name "localadmin" -ErrorAction SilentlyContinue)) {
          net user localadmin Welcome1! /add 2>$null
          Write-Host "[OK] Weak local admin created (localadmin / Welcome1!)"
        } else {
          Write-Host "[OK] Local admin already exists"
        }
        net localgroup administrators localadmin /add 2>$null

        # -----------------------------------------------------------
        # ENABLE WINRM FOR LATERAL MOVEMENT
        # -----------------------------------------------------------
        Enable-PSRemoting -Force -ErrorAction SilentlyContinue
        Set-Item WSMan:\localhost\Service\Auth\Basic -Value $true -ErrorAction SilentlyContinue
        Set-Item WSMan:\localhost\Service\AllowUnencrypted -Value $true -ErrorAction SilentlyContinue

        Write-Host "[OK] WinRM enabled for lateral movement"

        # -----------------------------------------------------------
        # DISABLE SMB SIGNING (RELAY ATTACKS)
        # -----------------------------------------------------------
        Set-ItemProperty `
          -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters" `
          -Name RequireSecuritySignature `
          -Value 0 `
          -Force `
          -ErrorAction SilentlyContinue

        Write-Host "[OK] SMB signing disabled for relay attacks"

        # -----------------------------------------------------------
        # CREATE WEAK SMB SHARE
        # -----------------------------------------------------------
        New-Item -ItemType Directory -Path "C:\\VulnerableShare" -Force -ErrorAction SilentlyContinue | Out-Null
        New-SmbShare -Name "Vulnerable" -Path "C:\\VulnerableShare" -FullAccess "Everyone" -ErrorAction SilentlyContinue

        # Create a test file
        "This is a vulnerable SMB share for PJPT practice" | Out-File "C:\\VulnerableShare\\README.txt" -Force

        Write-Host "[OK] Vulnerable SMB share created"

        # -----------------------------------------------------------
        # SQL SERVER EXPRESS INSTALLATION FOR REAL KERBEROASTING
        # -----------------------------------------------------------
        Write-Host "[*] Installing SQL Server Express for realistic Kerberoasting..."
        
        try {
          # Download SQL Server Express
          $sqlUrl = "https://go.microsoft.com/fwlink/?linkid=866658"
          $installerPath = "C:\\sql_express.exe"
          
          Write-Host "[*] Downloading SQL Server Express..."
          Invoke-WebRequest -Uri $sqlUrl -OutFile $installerPath -ErrorAction SilentlyContinue
          
          if (Test-Path $installerPath) {
            Write-Host "[*] Installing SQL Server Express..."
            Start-Process -FilePath $installerPath -ArgumentList `
              "/Q /ACTION=Install /FEATURES=SQLEngine /INSTANCENAME=SQLEXPRESS " `
              "/SQLSVCACCOUNT='#{DOMAIN_NETBIOS}\\svc_kerberoast' " `
              "/SQLSVCPASSWORD='ServiceP@ss2' " `
              "/TCPENABLED=1 /NPENABLED=1 " `
              "/IACCEPTSQLSERVERLICENSETERMS" `
              -Wait -NoNewWindow -ErrorAction SilentlyContinue
            
            # Clean up installer
            Remove-Item -Path $installerPath -Force -ErrorAction SilentlyContinue
            
            Write-Host "[OK] SQL Server Express installed using svc_kerberoast account"
          } else {
            Write-Host "[WARNING] SQL Server installer download failed"
          }
        } catch {
          Write-Host "[WARNING] SQL Server installation failed: $_"
        }

        # -----------------------------------------------------------
        # CREATE FIREWALL RULES FOR ATTACK VECTORS
        # -----------------------------------------------------------
        Write-Host "[*] Configuring firewall for attack vectors..."
        
        # SMB ports
        New-NetFirewallRule -DisplayName "SMB Inbound" -Direction Inbound -Protocol TCP -LocalPort 445 -Action Allow -ErrorAction SilentlyContinue
        New-NetFirewallRule -DisplayName "SMB Outbound" -Direction Outbound -Protocol TCP -LocalPort 445 -Action Allow -ErrorAction SilentlyContinue
        
        # SQL Server ports
        New-NetFirewallRule -DisplayName "SQL TCP 1433" -Direction Inbound -Protocol TCP -LocalPort 1433 -Action Allow -ErrorAction SilentlyContinue
        
        # RPC ports for DCOM attacks
        New-NetFirewallRule -DisplayName "RPC Endpoint Mapper" -Direction Inbound -Protocol TCP -LocalPort 135 -Action Allow -ErrorAction SilentlyContinue
        New-NetFirewallRule -DisplayName "RPC Dynamic" -Direction Inbound -Protocol TCP -LocalPort 49152-65535 -Action Allow -ErrorAction SilentlyContinue
        
        # WinRM ports
        New-NetFirewallRule -DisplayName "WinRM HTTP" -Direction Inbound -Protocol TCP -LocalPort 5985 -Action Allow -ErrorAction SilentlyContinue
        
        # LDAP for AD attacks
        New-NetFirewallRule -DisplayName "LDAP" -Direction Inbound -Protocol TCP -LocalPort 389 -Action Allow -ErrorAction SilentlyContinue
        New-NetFirewallRule -DisplayName "LDAP SSL" -Direction Inbound -Protocol TCP -LocalPort 636 -Action Allow -ErrorAction SilentlyContinue
        
        Write-Host "[OK] Firewall configured for attack vectors"

        # -----------------------------------------------------------
        # CREATE VULNERABLE REGISTRY ENTRIES
        # -----------------------------------------------------------
        Write-Host "[*] Creating vulnerable registry entries..."
        
        # Weak encryption settings
        New-ItemProperty -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa" -Name "NoLMHash" -Value 0 -PropertyType DWORD -Force -ErrorAction SilentlyContinue
        
        # AutoRun for persistence simulation
        New-Item -Path "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" -Force -ErrorAction SilentlyContinue
        Set-ItemProperty -Path "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" -Name "TestPersistence" -Value "C:\\Windows\\System32\\calc.exe" -ErrorAction SilentlyContinue
        
        Write-Host "[OK] Vulnerable registry entries created"

        # -----------------------------------------------------------
        # CREATE WEAK CREDENTIAL FILES
        # -----------------------------------------------------------
        Write-Host "[*] Planting weak credential files..."
        
        # Create a file with credentials (simulating credential leakage)
        $credContent = @"
[Credentials]
username=localadmin
password=Welcome1!
domain=#{DOMAIN_NAME}
service=sql
"@
        
        $credContent | Out-File "C:\\Users\\Public\\sql_config.ini" -Encoding ASCII -Force
        attrib +h +s "C:\\Users\\Public\\sql_config.ini" 2>$null
        
        # Create another in ProgramData
        "backup_password=Passw0rdBackup!" | Out-File "C:\\ProgramData\\backup_config.txt" -Force
        
        Write-Host "[OK] Weak credential files planted"

        # -----------------------------------------------------------
        # DISABLE SECURITY FEATURES FOR LAB
        # -----------------------------------------------------------
        Write-Host "[*] Disabling security features for lab purposes..."
        
        # Disable Windows Defender real-time monitoring
        Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
        
        # Disable User Account Control
        Set-ItemProperty -Path "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System" -Name "EnableLUA" -Value 0 -ErrorAction SilentlyContinue
        
        Write-Host "[OK] Security features disabled for lab environment"

        Write-Host ""
        Write-Host "=============================================="
        Write-Host " DB01 VULNERABLE CONFIG COMPLETE "
        Write-Host "=============================================="
        Write-Host "Vulnerabilities configured:"
        Write-Host "  - Local admin password reuse (Welcome1!)"
        Write-Host "  - SMB signing disabled (Relay attacks)"
        Write-Host "  - Weak SMB share with Everyone access"
        Write-Host "  - WinRM enabled for lateral movement"
        Write-Host "  - SQL Server Express installed (Real Kerberoasting)"
        Write-Host "  - Firewall opened for common attack vectors"
        Write-Host "  - Credential files planted for discovery"
        Write-Host "  - Security features disabled for lab"
        Write-Host ""
        Write-Host "Ready for:"
        Write-Host "  - Kerberoasting (svc_kerberoast/ServiceP@ss2)"
        Write-Host "  - NTLM relay attacks"
        Write-Host "  - Lateral movement via WinRM/SMB"
        Write-Host "  - Credential hunting"
        Write-Host "  - SQL Server enumeration"
        Write-Host "=============================================="
        
        # Create completion flag
        "DB01 PJPT vulnerable configuration complete at $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File C:\\DB01-PJPT-COMPLETE.txt -Force
      SHELL
  end

  # ---------- AD CS VULNERABLE SERVER (CA01) - SIMPLIFIED VERSION ----------
  config.vm.define "CA01" do |vm|
    vm.vm.box = "peru/windows-server-2022-standard-x64-eval"
    vm.vm.hostname = "CA01"
    vm.vm.synced_folder ".", "/vagrant", disabled: true

    vm.vm.communicator = "winrm"
    vm.winrm.username = "vagrant"
    vm.winrm.password = "vagrant"
    vm.winrm.transport = :plaintext
    vm.winrm.port = 5985
    vm.winrm.timeout = 600

    configure_network(vm, "172.28.128.24")
    configure_libvirt(vm, WINDOWS_CONFIG.merge(memory: 2048, disk_size: 40))

    wait_for_dc(vm)

    vm.vm.provision "shell",
      name: "domain-join",
      privileged: true,
      reboot: "always",
      inline: <<-SHELL
        Write-Host "=============================================="
        Write-Host " CA01 DOMAIN JOIN "
        Write-Host "=============================================="
        
        # Set DNS to DC01 on vagrant0 network
        $adapter = Get-NetAdapter | Where-Object {$_.Status -eq 'Up'} | Select-Object -First 1
        if ($adapter) {
          Set-DnsClientServerAddress -InterfaceIndex $adapter.ifIndex -ServerAddresses '#{DC_IP}'
          Write-Host "[OK] DNS set to DC01 (#{DC_IP})"
        }
        
        $sec = ConvertTo-SecureString '#{DOMAIN_JOIN_PASS}' -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential('#{DOMAIN_NETBIOS}\\#{DOMAIN_JOIN_USER}', $sec)
        
        # Try domain join with retry logic
        $maxAttempts = 3
        $attempt = 0
        $joined = $false
        
        while ($attempt -lt $maxAttempts -and -not $joined) {
          $attempt++
          try {
            Write-Host "[*] Domain join attempt $attempt of $maxAttempts..."
            Add-Computer -DomainName "#{DOMAIN_NAME}" -Credential $cred -Force -ErrorAction Stop
            $joined = $true
            Write-Host "[SUCCESS] Domain join completed"
          } catch {
            Write-Host "Domain join attempt $attempt failed: $_"
            if ($attempt -lt $maxAttempts) {
              Write-Host "Retrying in 30 seconds..."
              Start-Sleep -Seconds 30
            }
          }
        }
        
        if (-not $joined) {
          Write-Error "Failed to join domain after $maxAttempts attempts"
          exit 1
        }
        
        Rename-Computer -NewName 'CA01' -Force
        Write-Host "[OK] Computer renamed to CA01"
        
        Write-Host "[*] Rebooting for domain join to take effect..."
        shutdown /r /t 5 /f
      SHELL

    vm.vm.provision :reload, name: "reboot-after-domain-join"

    vm.vm.provision "shell",
      name: "adcs-vulnerable-setup-simple",
      privileged: true,
      inline: <<-SHELL
        if (Test-Path "C:\\CA01-ADCS-READY.txt") {
          Write-Host "CA01 AD CS already configured. Skipping."
          exit 0
        }

        Write-Host "=============================================="
        Write-Host " SIMPLE ADCS SETUP FOR CERTIPY LAB "
        Write-Host "=============================================="

        # 1. Install AD CS
        Install-WindowsFeature AD-Certificate -IncludeManagementTools
        Install-AdcsCertificationAuthority -CAType EnterpriseRootCa -Force

        # 2. Wait and restart
        Start-Sleep -Seconds 30
        Restart-Service certsvc -Force
        Start-Sleep -Seconds 10

        # 3. We'll use existing templates but modify settings
        # Enable EDITF_ATTRIBUTESUBJECTALTNAME2 for ESC1-like behavior
        certutil -setreg policy\\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2
        
        # Enable LDAP referrals
        certutil -setreg policy\\EditFlags +EDITF_ENABLELDAPREFERRALS
        
        # Enable all request attributes (simplified ESC1)
        certutil -setreg policy\\EditFlags +EDITF_REQUESTEXTENSIONLIST
        
        Write-Host "[OK] Enabled vulnerable CA policy flags"

        # 4. Publish vulnerable templates (they must exist in AD)
        # In lab, templates are created on DC01. Here we just publish them.
        Write-Host "[*] Publishing templates to CA..."
        
        # Try to publish common templates
        $templates = @("User", "Computer", "WebServer", "DomainController", "VulnESC1", "VulnWebServer", "VulnESC6")
        foreach ($template in $templates) {
          certutil -setcatemplates "+$template" 2>$null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "  Published: $template"
          }
        }

        # 5. Configure weak certificate binding (ESC9)
        reg add "HKLM\\SYSTEM\\CurrentControlSet\\Services\\Kdc" /v "StrongCertificateBindingEnforcement" /t REG_DWORD /d 0 /f
        
        Write-Host "[OK] Disabled strong certificate binding"

        # 6. Configure CA for HTTP enrollment (for ESC8 relay)
        certutil -setreg policy\\EditFlags +EDITF_ENABLEAKIKEYID +EDITF_ENABLEAKIISSUERNAME +EDITF_ENABLEAKIISSUERSERIAL
        certutil -vroot

        # 7. Create web enrollment virtual directory if needed
        Install-WindowsFeature ADCS-Web-Enrollment -IncludeManagementTools 2>$null
        
        # 8. Finalize
        Restart-Service certsvc -Force
        Start-Sleep -Seconds 10

        # Get CA info
        $caInfo = certutil -cainfo
        $caName = ($caInfo | Select-String "CA Name:" | Select-Object -First 1) -replace "CA Name:", "" -replace "\s+", ""
        
        "CA Name: $caName" | Out-File C:\\CA-INFO.txt -Force
        "CA01 AD CS ready for Certipy at $(Get-Date)" | Out-File C:\\CA01-ADCS-READY.txt -Force

        Write-Host "=============================================="
        Write-Host " SIMPLE ADCS LAB READY "
        Write-Host "=============================================="
        Write-Host "CA Name: $caName"
        Write-Host ""
        Write-Host "For Certipy tests, use:"
        Write-Host "  certipy find -u alice.adams@lab.local -p 'Passw0rd!' -dc-ip 172.28.128.21"
        Write-Host ""
        Write-Host "Note: For full ESC1/ESC2, create templates on DC01 first."
        Write-Host "This setup enables basic certificate attacks for labs."
        Write-Host "=============================================="
      SHELL
  end

  # ---------- OWASP JUICE SHOP ----------
  config.vm.define "juice-shop" do |vm|
    vm.vm.box = "ubuntu/jammy64"
    vm.vm.hostname = "juice-shop"
    
    configure_network(vm, "172.28.128.15")
    configure_libvirt(vm, memory: 2048, cpus: 2, disk_size: 20, nic_model_type: "virtio")
    
    vm.vm.provision "shell",
      run: "once",
      inline: <<-SHELL
#!/bin/bash
set -e

echo "Setting up OWASP Juice Shop..."

# Network configuration
echo "nameserver 172.28.128.21" > /etc/resolv.conf
echo "search lab.local" >> /etc/resolv.conf
echo "172.28.128.21 dc01.lab.local dc01" >> /etc/hosts
echo "172.28.128.23 db01.lab.local db01" >> /etc/hosts
echo "172.28.128.30 win10.lab.local win10" >> /etc/hosts
echo "172.28.128.50 pnpt-internal.lab.local pnpt-internal" >> /etc/hosts

# Update and install prerequisites
apt-get update
apt-get install -y curl git docker.io docker-compose

# Start and enable Docker
systemctl start docker
systemctl enable docker

# Pull Juice Shop Docker image
docker pull bkimminich/juice-shop

# Run Juice Shop container
docker run -d \
  --name juice-shop \
  -p 80:3000 \
  -p 443:3000 \
  --restart unless-stopped \
  bkimminich/juice-shop

# Create a simple startup script
cat > /usr/local/bin/start-juice-shop.sh << 'EOF'
#!/bin/bash
docker start juice-shop 2>/dev/null || docker run -d --name juice-shop -p 80:3000 -p 443:3000 bkimminich/juice-shop
echo "Juice Shop is running on http://$(hostname -I | awk '{print $1}'):80"
EOF

chmod +x /usr/local/bin/start-juice-shop.sh

# Create systemd service
cat > /etc/systemd/system/juice-shop.service << 'EOF'
[Unit]
Description=OWASP Juice Shop
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/local/bin/start-juice-shop.sh
ExecStop=/usr/bin/docker stop juice-shop

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable juice-shop.service
systemctl start juice-shop.service

echo "OWASP Juice Shop installation complete!"
echo "Access Juice Shop at: http://$(hostname -I | awk '{print $1}')"
SHELL
      
    vm.vm.synced_folder ".", "/vagrant", disabled: true
  end
end