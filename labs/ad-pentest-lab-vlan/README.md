# Advanced Active Directory Pentest Lab (VLAN Segmented)

## Overview

This directory contains an **advanced, enterprise-style Active Directory penetration testing lab** built with **Vagrant + libvirt** using **Linux bridges and VLAN segmentation**.

Unlike flat-network labs, this environment simulates realistic corporate network segmentation, allowing you to practice:

- Network enumeration across VLANs
- Pivoting and lateral movement
- Firewall / routing assumptions
- Multi-homed attacker scenarios
- Segmentation bypass techniques

This lab is intended for **intermediate to advanced users** preparing for certifications such as **PNPT, CRTO, OSCP**, or for defenders validating segmentation controls.

---

## Key Differences vs Standard Lab

| Feature                     | Standard Lab | VLAN Lab |
| --------------------------- | ------------ | -------- |
| Flat network                | ✓            | ✗        |
| VLAN segmentation           | ✗            | ✓        |
| Multiple NICs per VM        | Limited      | ✓        |
| Linux bridge networking     | ✗            | ✓        |
| Realistic enterprise layout | ✗            | ✓        |

---

## Requirements

- Linux host system
- KVM / QEMU
- libvirt
- Vagrant
- Vagrant libvirt provider
- Root or sudo access (for bridge/VLAN creation)

See `docs/REQUIREMENTS.md` for details.

---

## Directory Structure

```
.
├── configs/        # Lab configuration (VLANs, subnets, IPs)
├── scripts/        # Setup, validation, and diagram scripts
├── diagrams/       # Network diagrams (Mermaid / images)
├── docs/           # Detailed documentation
├── requirements.txt
└── README.md
```

---

## Quick Start

> ⚠️ **Warning**: This lab creates Linux bridges and VLAN interfaces on your host. It is isolated but intended for advanced users.

```bash
# 1. Review configuration
cat configs/lab_config.yaml

# 2. Create VLANs and bridges
sudo ./scripts/setup-vlans.sh

# 3. Attach virtual machines to VLAN bridges
sudo ./scripts/attach-vlan-bridges.sh

# 4. Validate segmentation and connectivity
./scripts/test-vlans.sh
```

Once networking is prepared, you can start the lab VMs using Vagrant from the parent lab directory.

---

## Network Topology

A visual overview of the VLAN layout is available in the `diagrams/` directory.

You can regenerate the diagram at any time:

```bash
./scripts/generate-network-diagram.sh
```

---

## Documentation

- `docs/NETWORKING.md` – VLAN design and traffic flow
- `docs/REQUIREMENTS.md` – Host and software requirements
- `docs/TROUBLESHOOTING.md` – Common issues and fixes

---

## Safety Notes

- Scripts modify libvirt networking and Linux bridges
- Safe to re-run unless otherwise stated
- Tested on libvirt-based systems only

---

## License

This lab is provided for **educational and training purposes only**.

Do not expose vulnerable machines to untrusted networks.

# Enterprise Active Directory Pentest Lab (VLAN Edition)

## Overview

This repository contains a fully featured, intentionally vulnerable **enterprise-style penetration testing lab** designed for hands-on offensive security training and certification preparation.

The environment simulates a modern corporate network with **realistic VLAN segmentation**, Active Directory infrastructure, DevOps workloads, external-facing services, and a controlled enterprise firewall.

The lab is built using **Vagrant + libvirt/KVM** and is optimized for **PJPT, PNPT, OSCP, CRTO, and enterprise red team practice**.

> ⚠️ This environment is intentionally insecure and must be used **only for authorized, educational purposes**.

---

## Architecture Philosophy

### NAT vs VLAN vs Firewall (Important Clarification)

#### NAT Network (Management / Internet Access)

- Provided by libvirt/Vagrant
- Used only for:
  - OS updates
  - Package installation
  - Tool downloads

- Not part of the attack simulation
- Does **not** represent an enterprise LAN

> NAT exists for convenience, not realism.

---

#### VLAN Networks (Enterprise Segmentation)

- Implemented using **Linux bridges**
- Provide **Layer 2 isolation only**
- No routing, no gateway, no firewall by default
- Each VLAN behaves as a separate broadcast domain

This accurately models:

- Internal enterprise segmentation
- East/West isolation
- Switch-level network separation

---

#### pfSense Firewall (Enterprise Routing & Policy)

- Disabled by default
- When enabled:
  - Becomes the **only Layer 3 routing device**
  - Enforces firewall policies
  - Enables controlled inter-VLAN communication
  - Acts as the pivot point for escalation scenarios

---

## Network Segmentation

| VLAN | Purpose                        | Subnet         |
| ---- | ------------------------------ | -------------- |
| 10   | Management / AD Infrastructure | 172.28.10.0/24 |
| 20   | Workstations                   | 172.28.20.0/24 |
| 30   | Servers & DevOps               | 172.28.30.0/24 |
| 40   | DMZ / External Services        | 172.28.40.0/24 |
| 99   | Attacker / Red Team            | 172.28.99.0/24 |

---

## Target Systems

### Windows Domain Environment

| Host  | VLAN | Role                                 |
| ----- | ---- | ------------------------------------ |
| DC01  | 10   | Domain Controller (AD DS, DNS, LDAP) |
| CA01  | 10   | AD Certificate Services              |
| DB01  | 10   | SQL Server                           |
| WIN10 | 20   | Domain Workstation                   |

#### Active Directory Attack Scenarios

- AS-REP Roasting
- Kerberoasting
- GPP password extraction
- SMB relay
- ACL & AdminSDHolder abuse
- Delegation attacks

---

### Linux, Cloud & DevOps Targets

| Host               | VLAN | Focus                     |
| ------------------ | ---- | ------------------------- |
| pentestplus-target | 30   | PenTest+ scenarios        |
| pjpt-target        | 30   | Entry-level exploitation  |
| oscp-target        | 30   | Privilege escalation      |
| cloud-pentest      | 30   | Cloud credential exposure |
| pnpt-internal      | 30   | Internal-only misconfigs  |
| LLM01              | 30   | OWASP LLM vulnerabilities |

---

### DMZ / External-Facing Systems

| Host                   | VLAN | Focus                   |
| ---------------------- | ---- | ----------------------- |
| metasploitable2        | 40   | Legacy exploits         |
| metasploitable3-ubuntu | 40   | Web attacks             |
| metasploitable3-win2k8 | 40   | Legacy Windows exploits |
| juice-shop             | 40   | Modern web/API testing  |

---

### Attacker System

| Host         | VLAN | Purpose                  |
| ------------ | ---- | ------------------------ |
| kali-libvirt | 99   | Red team attack platform |

- Multi-NIC (NAT + VLAN 99)
- Central pivot point for all attacks

---

## Attack Surface Control

### pfSense OFF (Default)

- No inter-VLAN routing
- Full Layer 2 isolation
- Single-segment attacks only

### pfSense ON

- Controlled inter-VLAN routing
- Firewall rule enforcement
- Pivoting and lateral movement
- Relay and segmentation bypass scenarios

---

## Setup Instructions

### 1. Requirements

- Linux host
- KVM / libvirt
- Vagrant (libvirt provider)
- jq, bridge-utils, iproute2

---

### 2. VLAN Bridge Setup (Host)

```bash
sudo ./scripts/setup-vlans.sh
```

Verify:

```bash
./scripts/test-vlans.sh
```

---

### 3. Launch the Lab

```bash
vagrant up
```

Optional:

```bash
vagrant up pfsense
```

---

## Security Notice

- This lab is intentionally vulnerable
- Never expose it to the internet
- Never reuse real credentials
- Do not deploy in production

---

## License

MIT License — Educational Use Only

---

## Author

**Miguel A. Carlo**
Offensive Security | Red Team | Enterprise Pentesting
